import{_ as te}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as n,a as J,p as re,c as h,o as d,d as a,w as s,f as i,q as ne,s as de,l as _,F as C,v as R,h as c,t as M,b as P,k as G,G as ie,E as p}from"./index-Bf8p-mK5.js";const ue={class:"admins-page"},ce={class:"card-header"},pe={__name:"Admins",setup(me){const U=n(!1),F=n([]),L=n([]),D=n([]),g=n(!1),w=n(!1),x=n(!1),j=n(!1),S=n(!1),A=n([]),N=n(null),T=n(null),q=n(null),o=J({user_id:"",role_code:"",school_id:"",event_id:"",initial_password:""}),y=J({new_password:""}),H={user_id:[{required:!0,message:"请选择用户",trigger:"change"}],role_code:[{required:!0,message:"请选择角色",trigger:"change"}],school_id:[{required:!0,message:"请选择学校",trigger:"change"}],initial_password:[{required:!0,message:"请设置初始密码",trigger:"blur"},{min:6,message:"密码至少6位",trigger:"blur"}]},K={new_password:[{required:!0,message:"请设置新密码",trigger:"blur"},{min:6,message:"密码至少6位",trigger:"blur"}]},m=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,Q=async()=>{try{const e=await(await fetch(`/api/admin/schools?user_id=${m()}`)).json();e.success&&(L.value=e.data)}catch(t){console.error("Load schools error:",t)}},W=async()=>{try{const e=await(await fetch(`/api/admin/events?user_id=${m()}`)).json();e.success&&(D.value=e.data)}catch(t){console.error("Load events error:",t)}},X=()=>{o.school_id="",o.event_id=""},b=async()=>{U.value=!0;try{const e=await(await fetch(`/api/admin/admins?user_id=${m()}`)).json();e.success&&(F.value=e.data)}catch(t){console.error("Load admins error:",t)}finally{U.value=!1}},Y=async t=>{if(!t){A.value=[];return}S.value=!0;try{const r=await(await fetch(`/api/admin/users?user_id=${m()}&keyword=${t}&limit=10`)).json();r.success&&(A.value=r.data)}catch(e){console.error("Search users error:",e)}finally{S.value=!1}},Z=async()=>{if(await N.value.validate().catch(()=>!1)){x.value=!0;try{const r=await(await fetch("/api/admin/admins",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...o,granted_by:m()})})).json();r.success?(p.success("添加成功"),g.value=!1,o.user_id="",o.role_code="",o.school_id="",o.event_id="",o.initial_password="",b()):p.error(r.message||"添加失败")}catch(e){console.error("Add admin error:",e),p.error("添加失败")}finally{x.value=!1}}},ee=t=>{q.value=t,y.new_password="",w.value=!0},le=async()=>{if(await T.value.validate().catch(()=>!1)){j.value=!0;try{const r=await(await fetch(`/api/admin/admins/${q.value.id}/reset-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:m(),new_password:y.new_password})})).json();r.success?(p.success("密码已重置"),w.value=!1,b()):p.error(r.message||"重置失败")}catch(e){console.error("Reset password error:",e),p.error("重置失败")}finally{j.value=!1}}},ae=async t=>{var u;const e=((u=t.role_codes)==null?void 0:u.split(","))||[];if(e.length===0)return;const r=e[0];try{await ie.confirm(`确定要移除 ${t.name} 的管理员角色吗？`,"确认移除",{type:"warning"});const V=await(await fetch(`/api/admin/admins/${t.id}/role/${r}?user_id=${m()}`,{method:"DELETE"})).json();V.success?(p.success("已移除"),b()):p.error(V.message||"移除失败")}catch{}};return re(()=>{b(),Q(),W()}),(t,e)=>{const r=i("el-button"),u=i("el-table-column"),E=i("el-tag"),V=i("el-table"),se=i("el-card"),f=i("el-option"),k=i("el-select"),v=i("el-form-item"),B=i("el-input"),O=i("el-form"),z=i("el-dialog"),oe=ne("loading");return d(),h("div",ue,[a(se,null,{header:s(()=>[P("div",ce,[e[12]||(e[12]=P("span",null,"管理员管理",-1)),a(r,{type:"primary",onClick:e[0]||(e[0]=l=>g.value=!0)},{default:s(()=>[...e[11]||(e[11]=[c("添加管理员",-1)])]),_:1})])]),default:s(()=>[de((d(),_(V,{data:F.value,stripe:""},{default:s(()=>[a(u,{prop:"id",label:"ID",width:"80"}),a(u,{prop:"name",label:"姓名"}),a(u,{prop:"phone",label:"手机号"}),a(u,{prop:"school_name",label:"学校"}),a(u,{label:"角色"},{default:s(({row:l})=>{var $;return[(d(!0),h(C,null,R(($=l.role_names)==null?void 0:$.split(","),I=>(d(),_(E,{key:I,size:"small",class:"role-tag"},{default:s(()=>[c(M(I),1)]),_:2},1024))),128))]}),_:1}),a(u,{label:"密码状态",width:"100"},{default:s(({row:l})=>[a(E,{type:l.password_changed?"success":"warning",size:"small"},{default:s(()=>[c(M(l.password_changed?"已修改":"初始"),1)]),_:2},1032,["type"])]),_:1}),a(u,{label:"操作",width:"200"},{default:s(({row:l})=>[a(r,{size:"small",onClick:$=>ee(l)},{default:s(()=>[...e[13]||(e[13]=[c("重置密码",-1)])]),_:1},8,["onClick"]),a(r,{size:"small",type:"danger",onClick:$=>ae(l)},{default:s(()=>[...e[14]||(e[14]=[c("移除角色",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[oe,U.value]])]),_:1}),a(z,{modelValue:g.value,"onUpdate:modelValue":e[7]||(e[7]=l=>g.value=l),title:"添加管理员",width:"500px"},{footer:s(()=>[a(r,{onClick:e[6]||(e[6]=l=>g.value=!1)},{default:s(()=>[...e[15]||(e[15]=[c("取消",-1)])]),_:1}),a(r,{type:"primary",onClick:Z,loading:x.value},{default:s(()=>[...e[16]||(e[16]=[c("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[a(O,{model:o,rules:H,ref_key:"addFormRef",ref:N,"label-width":"100px"},{default:s(()=>[a(v,{label:"选择用户",prop:"user_id"},{default:s(()=>[a(k,{modelValue:o.user_id,"onUpdate:modelValue":e[1]||(e[1]=l=>o.user_id=l),filterable:"",remote:"","remote-method":Y,placeholder:"输入姓名或手机号搜索",loading:S.value,style:{width:"100%"}},{default:s(()=>[(d(!0),h(C,null,R(A.value,l=>(d(),_(f,{key:l.id,label:`${l.name} (${l.phone})`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),a(v,{label:"角色",prop:"role_code"},{default:s(()=>[a(k,{modelValue:o.role_code,"onUpdate:modelValue":e[2]||(e[2]=l=>o.role_code=l),placeholder:"选择角色",style:{width:"100%"},onChange:X},{default:s(()=>[a(f,{label:"超级管理员",value:"super_admin"}),a(f,{label:"学校管理员",value:"school_admin"}),a(f,{label:"赛事管理员",value:"event_manager"})]),_:1},8,["modelValue"])]),_:1}),o.role_code==="school_admin"?(d(),_(v,{key:0,label:"所属学校",prop:"school_id"},{default:s(()=>[a(k,{modelValue:o.school_id,"onUpdate:modelValue":e[3]||(e[3]=l=>o.school_id=l),placeholder:"选择学校",style:{width:"100%"},filterable:""},{default:s(()=>[(d(!0),h(C,null,R(L.value,l=>(d(),_(f,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):G("",!0),o.role_code==="event_manager"?(d(),_(v,{key:1,label:"管理赛事",prop:"event_id"},{default:s(()=>[a(k,{modelValue:o.event_id,"onUpdate:modelValue":e[4]||(e[4]=l=>o.event_id=l),placeholder:"选择赛事",style:{width:"100%"},filterable:""},{default:s(()=>[(d(!0),h(C,null,R(D.value,l=>(d(),_(f,{key:l.id,label:`${l.title} (${l.school_name||"全局"})`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):G("",!0),a(v,{label:"初始密码",prop:"initial_password"},{default:s(()=>[a(B,{modelValue:o.initial_password,"onUpdate:modelValue":e[5]||(e[5]=l=>o.initial_password=l),placeholder:"设置初始密码（至少6位）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(z,{modelValue:w.value,"onUpdate:modelValue":e[10]||(e[10]=l=>w.value=l),title:"重置密码",width:"400px"},{footer:s(()=>[a(r,{onClick:e[9]||(e[9]=l=>w.value=!1)},{default:s(()=>[...e[17]||(e[17]=[c("取消",-1)])]),_:1}),a(r,{type:"primary",onClick:le,loading:j.value},{default:s(()=>[...e[18]||(e[18]=[c("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[a(O,{model:y,rules:K,ref_key:"resetFormRef",ref:T,"label-width":"80px"},{default:s(()=>[a(v,{label:"新密码",prop:"new_password"},{default:s(()=>[a(B,{modelValue:y.new_password,"onUpdate:modelValue":e[8]||(e[8]=l=>y.new_password=l),placeholder:"新初始密码（至少6位）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},ve=te(pe,[["__scopeId","data-v-a2d6d5da"]]);export{ve as default};
