import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as n,a as B,n as ee,c as U,o as m,d as l,w as s,f as d,p as le,q as ae,k as A,F as O,x as z,h as u,t as I,b as J,s as se,E as p}from"./index-Dv_Uxel_.js";const oe={class:"admins-page"},te={class:"card-header"},re={__name:"Admins",setup(ne){const V=n(!1),F=n([]),c=n(!1),_=n(!1),k=n(!1),C=n(!1),$=n(!1),R=n([]),S=n(null),j=n(null),D=n(null),r=B({user_id:"",role_code:"",initial_password:""}),f=B({new_password:""}),M={user_id:[{required:!0,message:"请选择用户",trigger:"change"}],role_code:[{required:!0,message:"请选择角色",trigger:"change"}],initial_password:[{required:!0,message:"请设置初始密码",trigger:"blur"},{min:6,message:"密码至少6位",trigger:"blur"}]},P={new_password:[{required:!0,message:"请设置新密码",trigger:"blur"},{min:6,message:"密码至少6位",trigger:"blur"}]},g=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,v=async()=>{V.value=!0;try{const e=await(await fetch(`/api/admin/admins?user_id=${g()}`)).json();e.success&&(F.value=e.data)}catch(t){console.error("Load admins error:",t)}finally{V.value=!1}},G=async t=>{if(!t){R.value=[];return}$.value=!0;try{const o=await(await fetch(`/api/admin/users?user_id=${g()}&keyword=${t}&limit=10`)).json();o.success&&(R.value=o.data)}catch(e){console.error("Search users error:",e)}finally{$.value=!1}},H=async()=>{if(await S.value.validate().catch(()=>!1)){k.value=!0;try{const o=await(await fetch("/api/admin/admins",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...r,granted_by:g()})})).json();o.success?(p.success("添加成功"),c.value=!1,r.user_id="",r.role_code="",r.initial_password="",v()):p.error(o.message||"添加失败")}catch(e){console.error("Add admin error:",e),p.error("添加失败")}finally{k.value=!1}}},K=t=>{D.value=t,f.new_password="",_.value=!0},Q=async()=>{if(await j.value.validate().catch(()=>!1)){C.value=!0;try{const o=await(await fetch(`/api/admin/admins/${D.value.id}/reset-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:g(),new_password:f.new_password})})).json();o.success?(p.success("密码已重置"),_.value=!1,v()):p.error(o.message||"重置失败")}catch(e){console.error("Reset password error:",e),p.error("重置失败")}finally{C.value=!1}}},W=async t=>{var i;const e=((i=t.role_codes)==null?void 0:i.split(","))||[];if(e.length===0)return;const o=e[0];try{await se.confirm(`确定要移除 ${t.name} 的管理员角色吗？`,"确认移除",{type:"warning"});const w=await(await fetch(`/api/admin/admins/${t.id}/role/${o}?user_id=${g()}`,{method:"DELETE"})).json();w.success?(p.success("已移除"),v()):p.error(w.message||"移除失败")}catch{}};return ee(()=>{v()}),(t,e)=>{const o=d("el-button"),i=d("el-table-column"),x=d("el-tag"),w=d("el-table"),X=d("el-card"),y=d("el-option"),E=d("el-select"),b=d("el-form-item"),T=d("el-input"),L=d("el-form"),N=d("el-dialog"),Y=le("loading");return m(),U("div",oe,[l(X,null,{header:s(()=>[J("div",te,[e[10]||(e[10]=J("span",null,"管理员管理",-1)),l(o,{type:"primary",onClick:e[0]||(e[0]=a=>c.value=!0)},{default:s(()=>[...e[9]||(e[9]=[u("添加管理员",-1)])]),_:1})])]),default:s(()=>[ae((m(),A(w,{data:F.value,stripe:""},{default:s(()=>[l(i,{prop:"id",label:"ID",width:"80"}),l(i,{prop:"name",label:"姓名"}),l(i,{prop:"phone",label:"手机号"}),l(i,{prop:"school_name",label:"学校"}),l(i,{label:"角色"},{default:s(({row:a})=>{var h;return[(m(!0),U(O,null,z((h=a.role_names)==null?void 0:h.split(","),q=>(m(),A(x,{key:q,size:"small",class:"role-tag"},{default:s(()=>[u(I(q),1)]),_:2},1024))),128))]}),_:1}),l(i,{label:"密码状态",width:"100"},{default:s(({row:a})=>[l(x,{type:a.password_changed?"success":"warning",size:"small"},{default:s(()=>[u(I(a.password_changed?"已修改":"初始"),1)]),_:2},1032,["type"])]),_:1}),l(i,{label:"操作",width:"200"},{default:s(({row:a})=>[l(o,{size:"small",onClick:h=>K(a)},{default:s(()=>[...e[11]||(e[11]=[u("重置密码",-1)])]),_:1},8,["onClick"]),l(o,{size:"small",type:"danger",onClick:h=>W(a)},{default:s(()=>[...e[12]||(e[12]=[u("移除角色",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Y,V.value]])]),_:1}),l(N,{modelValue:c.value,"onUpdate:modelValue":e[5]||(e[5]=a=>c.value=a),title:"添加管理员",width:"500px"},{footer:s(()=>[l(o,{onClick:e[4]||(e[4]=a=>c.value=!1)},{default:s(()=>[...e[13]||(e[13]=[u("取消",-1)])]),_:1}),l(o,{type:"primary",onClick:H,loading:k.value},{default:s(()=>[...e[14]||(e[14]=[u("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[l(L,{model:r,rules:M,ref_key:"addFormRef",ref:S,"label-width":"100px"},{default:s(()=>[l(b,{label:"选择用户",prop:"user_id"},{default:s(()=>[l(E,{modelValue:r.user_id,"onUpdate:modelValue":e[1]||(e[1]=a=>r.user_id=a),filterable:"",remote:"","remote-method":G,placeholder:"输入姓名或手机号搜索",loading:$.value,style:{width:"100%"}},{default:s(()=>[(m(!0),U(O,null,z(R.value,a=>(m(),A(y,{key:a.id,label:`${a.name} (${a.phone})`,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),l(b,{label:"角色",prop:"role_code"},{default:s(()=>[l(E,{modelValue:r.role_code,"onUpdate:modelValue":e[2]||(e[2]=a=>r.role_code=a),placeholder:"选择角色",style:{width:"100%"}},{default:s(()=>[l(y,{label:"超级管理员",value:"super_admin"}),l(y,{label:"学校管理员",value:"school_admin"}),l(y,{label:"赛事管理员",value:"event_manager"})]),_:1},8,["modelValue"])]),_:1}),l(b,{label:"初始密码",prop:"initial_password"},{default:s(()=>[l(T,{modelValue:r.initial_password,"onUpdate:modelValue":e[3]||(e[3]=a=>r.initial_password=a),placeholder:"设置初始密码（至少6位）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(N,{modelValue:_.value,"onUpdate:modelValue":e[8]||(e[8]=a=>_.value=a),title:"重置密码",width:"400px"},{footer:s(()=>[l(o,{onClick:e[7]||(e[7]=a=>_.value=!1)},{default:s(()=>[...e[15]||(e[15]=[u("取消",-1)])]),_:1}),l(o,{type:"primary",onClick:Q,loading:C.value},{default:s(()=>[...e[16]||(e[16]=[u("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[l(L,{model:f,rules:P,ref_key:"resetFormRef",ref:j,"label-width":"80px"},{default:s(()=>[l(b,{label:"新密码",prop:"new_password"},{default:s(()=>[l(T,{modelValue:f.new_password,"onUpdate:modelValue":e[6]||(e[6]=a=>f.new_password=a),placeholder:"新初始密码（至少6位）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},ue=Z(re,[["__scopeId","data-v-a0ca4a6d"]]);export{ue as default};
