import{_ as ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as n,a as I,p as se,c as k,o as u,d as a,w as s,f as d,q as oe,s as te,l as y,F as A,v as F,h as c,t as J,b as M,k as re,z as ne,E as p}from"./index-BhydzvWF.js";const de={class:"admins-page"},ie={class:"card-header"},ue={__name:"Admins",setup(ce){const C=n(!1),D=n([]),E=n([]),_=n(!1),f=n(!1),$=n(!1),R=n(!1),U=n(!1),x=n([]),L=n(null),N=n(null),T=n(null),r=I({user_id:"",role_code:"",school_id:"",initial_password:""}),g=I({new_password:""}),P={user_id:[{required:!0,message:"请选择用户",trigger:"change"}],role_code:[{required:!0,message:"请选择角色",trigger:"change"}],school_id:[{required:!0,message:"请选择学校",trigger:"change"}],initial_password:[{required:!0,message:"请设置初始密码",trigger:"blur"},{min:6,message:"密码至少6位",trigger:"blur"}]},G={new_password:[{required:!0,message:"请设置新密码",trigger:"blur"},{min:6,message:"密码至少6位",trigger:"blur"}]},m=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,H=async()=>{try{const e=await(await fetch(`/api/admin/schools?user_id=${m()}`)).json();e.success&&(E.value=e.data)}catch(o){console.error("Load schools error:",o)}},K=()=>{r.school_id=""},h=async()=>{C.value=!0;try{const e=await(await fetch(`/api/admin/admins?user_id=${m()}`)).json();e.success&&(D.value=e.data)}catch(o){console.error("Load admins error:",o)}finally{C.value=!1}},Q=async o=>{if(!o){x.value=[];return}U.value=!0;try{const t=await(await fetch(`/api/admin/users?user_id=${m()}&keyword=${o}&limit=10`)).json();t.success&&(x.value=t.data)}catch(e){console.error("Search users error:",e)}finally{U.value=!1}},W=async()=>{if(await L.value.validate().catch(()=>!1)){$.value=!0;try{const t=await(await fetch("/api/admin/admins",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...r,granted_by:m()})})).json();t.success?(p.success("添加成功"),_.value=!1,r.user_id="",r.role_code="",r.school_id="",r.initial_password="",h()):p.error(t.message||"添加失败")}catch(e){console.error("Add admin error:",e),p.error("添加失败")}finally{$.value=!1}}},X=o=>{T.value=o,g.new_password="",f.value=!0},Y=async()=>{if(await N.value.validate().catch(()=>!1)){R.value=!0;try{const t=await(await fetch(`/api/admin/admins/${T.value.id}/reset-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:m(),new_password:g.new_password})})).json();t.success?(p.success("密码已重置"),f.value=!1,h()):p.error(t.message||"重置失败")}catch(e){console.error("Reset password error:",e),p.error("重置失败")}finally{R.value=!1}}},Z=async o=>{var i;const e=((i=o.role_codes)==null?void 0:i.split(","))||[];if(e.length===0)return;const t=e[0];try{await ne.confirm(`确定要移除 ${o.name} 的管理员角色吗？`,"确认移除",{type:"warning"});const b=await(await fetch(`/api/admin/admins/${o.id}/role/${t}?user_id=${m()}`,{method:"DELETE"})).json();b.success?(p.success("已移除"),h()):p.error(b.message||"移除失败")}catch{}};return se(()=>{h(),H()}),(o,e)=>{const t=d("el-button"),i=d("el-table-column"),S=d("el-tag"),b=d("el-table"),ee=d("el-card"),v=d("el-option"),j=d("el-select"),w=d("el-form-item"),q=d("el-input"),z=d("el-form"),B=d("el-dialog"),le=oe("loading");return u(),k("div",de,[a(ee,null,{header:s(()=>[M("div",ie,[e[11]||(e[11]=M("span",null,"管理员管理",-1)),a(t,{type:"primary",onClick:e[0]||(e[0]=l=>_.value=!0)},{default:s(()=>[...e[10]||(e[10]=[c("添加管理员",-1)])]),_:1})])]),default:s(()=>[te((u(),y(b,{data:D.value,stripe:""},{default:s(()=>[a(i,{prop:"id",label:"ID",width:"80"}),a(i,{prop:"name",label:"姓名"}),a(i,{prop:"phone",label:"手机号"}),a(i,{prop:"school_name",label:"学校"}),a(i,{label:"角色"},{default:s(({row:l})=>{var V;return[(u(!0),k(A,null,F((V=l.role_names)==null?void 0:V.split(","),O=>(u(),y(S,{key:O,size:"small",class:"role-tag"},{default:s(()=>[c(J(O),1)]),_:2},1024))),128))]}),_:1}),a(i,{label:"密码状态",width:"100"},{default:s(({row:l})=>[a(S,{type:l.password_changed?"success":"warning",size:"small"},{default:s(()=>[c(J(l.password_changed?"已修改":"初始"),1)]),_:2},1032,["type"])]),_:1}),a(i,{label:"操作",width:"200"},{default:s(({row:l})=>[a(t,{size:"small",onClick:V=>X(l)},{default:s(()=>[...e[12]||(e[12]=[c("重置密码",-1)])]),_:1},8,["onClick"]),a(t,{size:"small",type:"danger",onClick:V=>Z(l)},{default:s(()=>[...e[13]||(e[13]=[c("移除角色",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[le,C.value]])]),_:1}),a(B,{modelValue:_.value,"onUpdate:modelValue":e[6]||(e[6]=l=>_.value=l),title:"添加管理员",width:"500px"},{footer:s(()=>[a(t,{onClick:e[5]||(e[5]=l=>_.value=!1)},{default:s(()=>[...e[14]||(e[14]=[c("取消",-1)])]),_:1}),a(t,{type:"primary",onClick:W,loading:$.value},{default:s(()=>[...e[15]||(e[15]=[c("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[a(z,{model:r,rules:P,ref_key:"addFormRef",ref:L,"label-width":"100px"},{default:s(()=>[a(w,{label:"选择用户",prop:"user_id"},{default:s(()=>[a(j,{modelValue:r.user_id,"onUpdate:modelValue":e[1]||(e[1]=l=>r.user_id=l),filterable:"",remote:"","remote-method":Q,placeholder:"输入姓名或手机号搜索",loading:U.value,style:{width:"100%"}},{default:s(()=>[(u(!0),k(A,null,F(x.value,l=>(u(),y(v,{key:l.id,label:`${l.name} (${l.phone})`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),a(w,{label:"角色",prop:"role_code"},{default:s(()=>[a(j,{modelValue:r.role_code,"onUpdate:modelValue":e[2]||(e[2]=l=>r.role_code=l),placeholder:"选择角色",style:{width:"100%"},onChange:K},{default:s(()=>[a(v,{label:"超级管理员",value:"super_admin"}),a(v,{label:"学校管理员",value:"school_admin"}),a(v,{label:"赛事管理员",value:"event_manager"})]),_:1},8,["modelValue"])]),_:1}),r.role_code==="school_admin"?(u(),y(w,{key:0,label:"所属学校",prop:"school_id"},{default:s(()=>[a(j,{modelValue:r.school_id,"onUpdate:modelValue":e[3]||(e[3]=l=>r.school_id=l),placeholder:"选择学校",style:{width:"100%"},filterable:""},{default:s(()=>[(u(!0),k(A,null,F(E.value,l=>(u(),y(v,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):re("",!0),a(w,{label:"初始密码",prop:"initial_password"},{default:s(()=>[a(q,{modelValue:r.initial_password,"onUpdate:modelValue":e[4]||(e[4]=l=>r.initial_password=l),placeholder:"设置初始密码（至少6位）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(B,{modelValue:f.value,"onUpdate:modelValue":e[9]||(e[9]=l=>f.value=l),title:"重置密码",width:"400px"},{footer:s(()=>[a(t,{onClick:e[8]||(e[8]=l=>f.value=!1)},{default:s(()=>[...e[16]||(e[16]=[c("取消",-1)])]),_:1}),a(t,{type:"primary",onClick:Y,loading:R.value},{default:s(()=>[...e[17]||(e[17]=[c("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[a(z,{model:g,rules:G,ref_key:"resetFormRef",ref:N,"label-width":"80px"},{default:s(()=>[a(w,{label:"新密码",prop:"new_password"},{default:s(()=>[a(q,{modelValue:g.new_password,"onUpdate:modelValue":e[7]||(e[7]=l=>g.new_password=l),placeholder:"新初始密码（至少6位）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},_e=ae(ue,[["__scopeId","data-v-8324ee03"]]);export{_e as default};
