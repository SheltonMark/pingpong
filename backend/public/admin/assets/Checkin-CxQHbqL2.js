import{r as m,B as ve,p as _e,c as L,o as f,b as w,d as a,l as T,k as U,w as n,f as d,E as i,q as fe,h as v,s as A,t as b,F as H,v as Q,m as we,g as ge,G as he,n as be}from"./index-CFDikFN1.js";import{f as ye}from"./format-DoeqoNZs.js";import{_ as ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ce={class:"page"},Ve={class:"page-header"},Me={key:0},xe={class:"location-text"},Le={key:1},Te={class:"filter-bar"},Re={key:0,class:"record-summary"},Ue={class:"coord-display"},De={style:{"margin-left":"20px"}},Ee={__name:"Checkin",setup($e){const $=m(!1),j=m([]),F=m([]),k=m(!1),C=m(!1),S=m(!1),V=m(""),y=m("points"),D=m([]),B=m(!1),I=m(0),c=m({school_id:null,dateRange:null});let g=null,E=null,M=null;const o=m({name:"",latitude:"",longitude:"",radius:100,school_id:null}),R=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,W=()=>{be(()=>{if(!window.TMap){i.warning("地图加载中，请稍候...");return}const l=document.getElementById("mapContainer");if(!l)return;let r=new window.TMap.LatLng(30.2741,120.1551);o.value.latitude&&o.value.longitude&&(r=new window.TMap.LatLng(parseFloat(o.value.latitude),parseFloat(o.value.longitude))),g=new window.TMap.Map(l,{center:r,zoom:16,viewMode:"2D"}),g.on("click",u=>{const s=u.latLng.getLat().toFixed(6),_=u.latLng.getLng().toFixed(6);o.value.latitude=s,o.value.longitude=_,O(u.latLng)}),o.value.latitude&&o.value.longitude&&O(r)})},O=l=>{E&&E.setMap(null),M&&M.setMap(null),E=new window.TMap.MultiMarker({map:g,styles:{default:new window.TMap.MarkerStyle({width:30,height:40,anchor:{x:15,y:40}})},geometries:[{id:"point",position:l}]}),M=new window.TMap.MultiCircle({map:g,styles:{default:new window.TMap.CircleStyle({color:"rgba(64, 158, 255, 0.2)",borderColor:"rgba(64, 158, 255, 0.8)",borderWidth:2})},geometries:[{id:"circle",center:l,radius:o.value.radius}]}),g.setCenter(l)},X=()=>{M&&o.value.latitude&&o.value.longitude&&M.updateGeometries([{id:"circle",center:new window.TMap.LatLng(parseFloat(o.value.latitude),parseFloat(o.value.longitude)),radius:o.value.radius}])},Y=async()=>{if(!V.value){i.warning("请输入地址");return}try{const e=`https://apis.map.qq.com/ws/place/v1/search?keyword=${encodeURIComponent(V.value)}&boundary=region(全国,0)&key=ORNBZ-LB63J-CYOFT-XCIHE-ZMZCQ-NOBTU&output=jsonp&callback=searchCallback`,r=await new Promise((u,s)=>{const _="searchCallback_"+Date.now();window[_]=N=>{delete window[_],document.body.removeChild(h),u(N)};const h=document.createElement("script");h.src=e.replace("callback=searchCallback",`callback=${_}`),h.onerror=()=>{delete window[_],document.body.removeChild(h),s(new Error("请求失败"))},document.body.appendChild(h),setTimeout(()=>{window[_]&&(delete window[_],s(new Error("请求超时")))},1e4)});if(r.status===0&&r.data&&r.data.length>0){const u=r.data[0],s=u.location;o.value.latitude=s.lat.toFixed(6),o.value.longitude=s.lng.toFixed(6);const _=new window.TMap.LatLng(s.lat,s.lng);O(_),g.setZoom(17),i.success(`已定位到: ${u.title}`)}else i.warning("未找到该地址")}catch(l){console.error("搜索失败:",l),i.error("搜索失败，请重试")}},ee=()=>{g&&(g.destroy(),g=null,E=null,M=null)},P=async()=>{$.value=!0;try{const e=await(await fetch(`/api/admin/checkin-points?user_id=${R()}`)).json();e.success&&(j.value=e.data||[])}catch(l){console.error("加载签到点失败:",l),i.error("加载失败")}finally{$.value=!1}},ae=async()=>{try{const e=await(await fetch("/api/common/schools")).json();e.success&&(F.value=e.data||[])}catch(l){console.error("加载学校失败:",l)}},le=()=>{C.value=!1,o.value={name:"",latitude:"",longitude:"",radius:100,school_id:null},V.value="",k.value=!0},te=l=>{C.value=!0,o.value={...l},V.value="",k.value=!0},oe=async()=>{if(!o.value.name){i.warning("请填写签到点名称");return}if(!o.value.latitude||!o.value.longitude){i.warning("请在地图上选择位置");return}S.value=!0;try{const l=C.value?`/api/admin/checkin-points/${o.value.id}`:"/api/admin/checkin-points",e=C.value?"PUT":"POST",u=await(await fetch(l,{method:e,headers:{"Content-Type":"application/json"},body:JSON.stringify({...o.value,user_id:R()})})).json();u.success?(i.success(C.value?"更新成功":"添加成功"),k.value=!1,P()):i.error(u.message||"操作失败")}catch(l){console.error("提交失败:",l),i.error("操作失败")}finally{S.value=!1}},ne=async l=>{try{await he.confirm("确定要删除这个签到点吗？","提示",{type:"warning"});const r=await(await fetch(`/api/admin/checkin-points/${l.id}?user_id=${R()}`,{method:"DELETE"})).json();r.success?(i.success("删除成功"),P()):i.error(r.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),i.error("删除失败"))}},q=async()=>{B.value=!0;try{const l=new URLSearchParams({user_id:R()});c.value.school_id&&l.append("school_id",c.value.school_id),c.value.dateRange&&c.value.dateRange.length===2&&(l.append("start_date",c.value.dateRange[0]),l.append("end_date",c.value.dateRange[1]));const r=await(await fetch(`/api/admin/checkin-records?${l}`)).json();r.success&&(D.value=r.data||[],I.value=r.total||D.value.length)}catch(l){console.error("加载签到记录失败:",l),i.error("加载失败")}finally{B.value=!1}},se=async()=>{try{const l=new URLSearchParams({user_id:R(),export:"csv"});c.value.school_id&&l.append("school_id",c.value.school_id),c.value.dateRange&&c.value.dateRange.length===2&&(l.append("start_date",c.value.dateRange[0]),l.append("end_date",c.value.dateRange[1]));const e=await fetch(`/api/admin/checkin-records/export?${l}`);if(e.ok){const r=await e.blob(),u=window.URL.createObjectURL(r),s=document.createElement("a");s.href=u,s.download=`签到记录_${new Date().toISOString().slice(0,10)}.csv`,document.body.appendChild(s),s.click(),window.URL.revokeObjectURL(u),document.body.removeChild(s),i.success("导出成功")}else i.error("导出失败")}catch(l){console.error("导出失败:",l),i.error("导出失败")}};return ve(y,l=>{l==="records"&&q()}),_e(()=>{P(),ae()}),(l,e)=>{const r=d("Plus"),u=d("el-icon"),s=d("el-button"),_=d("Download"),h=d("el-tab-pane"),N=d("el-tabs"),p=d("el-table-column"),re=d("el-tag"),Z=d("el-table"),z=d("el-option"),J=d("el-select"),de=d("el-date-picker"),ie=d("el-card"),G=d("el-input"),x=d("el-form-item"),ue=d("el-slider"),ce=d("el-form"),pe=d("el-dialog"),K=fe("loading");return f(),L("div",Ce,[w("div",Ve,[e[11]||(e[11]=w("h2",null,"签到管理",-1)),y.value==="points"?(f(),T(s,{key:0,type:"primary",onClick:le},{default:n(()=>[a(u,null,{default:n(()=>[a(r)]),_:1}),e[9]||(e[9]=v(" 添加签到点 ",-1))]),_:1})):U("",!0),y.value==="records"?(f(),T(s,{key:1,type:"success",onClick:se},{default:n(()=>[a(u,null,{default:n(()=>[a(_)]),_:1}),e[10]||(e[10]=v(" 导出数据 ",-1))]),_:1})):U("",!0)]),a(ie,null,{default:n(()=>[a(N,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=t=>y.value=t)},{default:n(()=>[a(h,{label:"签到点管理",name:"points"}),a(h,{label:"签到记录",name:"records"})]),_:1},8,["modelValue"]),y.value==="points"?(f(),L("div",Me,[A((f(),T(Z,{data:j.value,stripe:""},{default:n(()=>[a(p,{prop:"id",label:"ID",width:"60"}),a(p,{prop:"name",label:"名称","min-width":"150"}),a(p,{label:"位置","min-width":"200"},{default:n(({row:t})=>[w("span",xe,b(t.latitude)+", "+b(t.longitude),1)]),_:1}),a(p,{prop:"radius",label:"有效半径",width:"100"},{default:n(({row:t})=>[v(b(t.radius)+"米 ",1)]),_:1}),a(p,{prop:"school_name",label:"所属学校",width:"150"}),a(p,{prop:"status",label:"状态",width:"80"},{default:n(({row:t})=>[a(re,{type:t.status==="active"?"success":"info"},{default:n(()=>[v(b(t.status==="active"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(p,{label:"操作",width:"150",fixed:"right"},{default:n(({row:t})=>[a(s,{size:"small",onClick:me=>te(t)},{default:n(()=>[...e[12]||(e[12]=[v("编辑",-1)])]),_:1},8,["onClick"]),a(s,{size:"small",type:"danger",onClick:me=>ne(t)},{default:n(()=>[...e[13]||(e[13]=[v("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[K,$.value]])])):U("",!0),y.value==="records"?(f(),L("div",Le,[w("div",Te,[a(J,{modelValue:c.value.school_id,"onUpdate:modelValue":e[1]||(e[1]=t=>c.value.school_id=t),placeholder:"选择学校",clearable:"",style:{width:"200px"}},{default:n(()=>[(f(!0),L(H,null,Q(F.value,t=>(f(),T(z,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(de,{modelValue:c.value.dateRange,"onUpdate:modelValue":e[2]||(e[2]=t=>c.value.dateRange=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{"margin-left":"12px"}},null,8,["modelValue"]),a(s,{type:"primary",onClick:q,style:{"margin-left":"12px"}},{default:n(()=>[...e[14]||(e[14]=[v("查询",-1)])]),_:1})]),A((f(),T(Z,{data:D.value,stripe:"",style:{"margin-top":"16px"}},{default:n(()=>[a(p,{prop:"user_name",label:"用户",width:"100"}),a(p,{prop:"phone",label:"手机号",width:"130"}),a(p,{prop:"school_name",label:"学校",width:"150"}),a(p,{prop:"point_name",label:"签到点","min-width":"150"}),a(p,{label:"签到时间",width:"160"},{default:n(({row:t})=>[v(b(we(ye)(t.check_in_time)),1)]),_:1}),a(p,{prop:"checkin_count",label:"累计签到",width:"100"})]),_:1},8,["data"])),[[K,B.value]]),D.value.length>0?(f(),L("div",Re," 共 "+b(I.value)+" 条签到记录 ",1)):U("",!0)])):U("",!0)]),_:1}),a(pe,{modelValue:k.value,"onUpdate:modelValue":e[8]||(e[8]=t=>k.value=t),title:C.value?"编辑签到点":"添加签到点",width:"700px",onOpened:W,onClosed:ee},{footer:n(()=>[a(s,{onClick:e[7]||(e[7]=t=>k.value=!1)},{default:n(()=>[...e[20]||(e[20]=[v("取消",-1)])]),_:1}),a(s,{type:"primary",onClick:oe,loading:S.value},{default:n(()=>[...e[21]||(e[21]=[v("确定",-1)])]),_:1},8,["loading"])]),default:n(()=>[a(ce,{model:o.value,"label-width":"100px"},{default:n(()=>[a(x,{label:"名称",required:""},{default:n(()=>[a(G,{modelValue:o.value.name,"onUpdate:modelValue":e[3]||(e[3]=t=>o.value.name=t),placeholder:"如：体育馆乒乓球室"},null,8,["modelValue"])]),_:1}),a(x,{label:"搜索地址"},{default:n(()=>[a(G,{modelValue:V.value,"onUpdate:modelValue":e[4]||(e[4]=t=>V.value=t),placeholder:"输入地址搜索，如：浙江工业大学体育馆",onKeyup:ge(Y,["enter"])},{append:n(()=>[a(s,{onClick:Y},{default:n(()=>[...e[15]||(e[15]=[v("搜索",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(x,{label:"地图选点"},{default:n(()=>[...e[16]||(e[16]=[w("div",{class:"map-container",id:"mapContainer"},[w("div",{class:"map-tip"},"点击地图选择位置")],-1)])]),_:1}),a(x,{label:"已选坐标"},{default:n(()=>[w("div",Ue,[w("span",null,[e[17]||(e[17]=v("纬度: ",-1)),w("strong",null,b(o.value.latitude||"未选择"),1)]),w("span",De,[e[18]||(e[18]=v("经度: ",-1)),w("strong",null,b(o.value.longitude||"未选择"),1)])])]),_:1}),a(x,{label:"有效半径"},{default:n(()=>[a(ue,{modelValue:o.value.radius,"onUpdate:modelValue":e[5]||(e[5]=t=>o.value.radius=t),min:10,max:500,step:10,"show-input":"",onChange:X},null,8,["modelValue"]),e[19]||(e[19]=w("span",{class:"radius-hint"},"用户需在此范围内才能签到",-1))]),_:1}),a(x,{label:"所属学校"},{default:n(()=>[a(J,{modelValue:o.value.school_id,"onUpdate:modelValue":e[6]||(e[6]=t=>o.value.school_id=t),clearable:"",placeholder:"请选择（可选）"},{default:n(()=>[(f(!0),L(H,null,Q(F.value,t=>(f(),T(z,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Oe=ke(Ee,[["__scopeId","data-v-c9b5d035"]]);export{Oe as default};
