import{r as f,p as Y,c as $,o as C,b as d,d as l,w as n,f as s,E as i,q as ee,h as p,s as te,l as D,t as h,g as le,F as ae,v as oe,z as ne,n as se}from"./index-BThRipZj.js";import{_ as ie}from"./_plugin-vue_export-helper-DlAUqK2U.js";const re={class:"page"},ue={class:"page-header"},de={class:"location-text"},ce={class:"coord-display"},pe={style:{"margin-left":"20px"}},me={__name:"Checkin",setup(ve){const M=f(!1),S=f([]),F=f([]),g=f(!1),_=f(!1),V=f(!1),w=f("");let m=null,k=null,y=null;const t=f({name:"",latitude:"",longitude:"",radius:100,school_id:null}),x=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,P=()=>{se(()=>{if(!window.TMap){i.warning("地图加载中，请稍候...");return}const a=document.getElementById("mapContainer");if(!a)return;let u=new window.TMap.LatLng(30.2741,120.1551);t.value.latitude&&t.value.longitude&&(u=new window.TMap.LatLng(parseFloat(t.value.latitude),parseFloat(t.value.longitude))),m=new window.TMap.Map(a,{center:u,zoom:16,viewMode:"2D"}),m.on("click",r=>{const c=r.latLng.getLat().toFixed(6),v=r.latLng.getLng().toFixed(6);t.value.latitude=c,t.value.longitude=v,L(r.latLng)}),t.value.latitude&&t.value.longitude&&L(u)})},L=a=>{k&&k.setMap(null),y&&y.setMap(null),k=new window.TMap.MultiMarker({map:m,styles:{default:new window.TMap.MarkerStyle({width:30,height:40,anchor:{x:15,y:40}})},geometries:[{id:"point",position:a}]}),y=new window.TMap.MultiCircle({map:m,styles:{default:new window.TMap.CircleStyle({color:"rgba(64, 158, 255, 0.2)",borderColor:"rgba(64, 158, 255, 0.8)",borderWidth:2})},geometries:[{id:"circle",center:a,radius:t.value.radius}]}),m.setCenter(a)},B=()=>{y&&t.value.latitude&&t.value.longitude&&y.updateGeometries([{id:"circle",center:new window.TMap.LatLng(parseFloat(t.value.latitude),parseFloat(t.value.longitude)),radius:t.value.radius}])},E=async()=>{if(!w.value){i.warning("请输入地址");return}try{const e=await new window.TMap.service.Search({pageSize:1}).searchRegion({keyword:w.value,boundary:"region(全国,0)"});if(e.data&&e.data.length>0){const u=e.data[0],r=u.location;t.value.latitude=r.lat.toFixed(6),t.value.longitude=r.lng.toFixed(6);const c=new window.TMap.LatLng(r.lat,r.lng);L(c),m.setZoom(17),i.success(`已定位到: ${u.title}`)}else i.warning("未找到该地址")}catch(a){console.error("搜索失败:",a),i.error("搜索失败，请重试")}},j=()=>{m&&(m.destroy(),m=null,k=null,y=null)},T=async()=>{M.value=!0;try{const e=await(await fetch(`/api/admin/checkin-points?user_id=${x()}`)).json();e.success&&(S.value=e.data||[])}catch(a){console.error("加载签到点失败:",a),i.error("加载失败")}finally{M.value=!1}},z=async()=>{try{const e=await(await fetch("/api/common/schools")).json();e.success&&(F.value=e.data||[])}catch(a){console.error("加载学校失败:",a)}},I=()=>{_.value=!1,t.value={name:"",latitude:"",longitude:"",radius:100,school_id:null},w.value="",g.value=!0},N=a=>{_.value=!0,t.value={...a},w.value="",g.value=!0},O=async()=>{if(!t.value.name){i.warning("请填写签到点名称");return}if(!t.value.latitude||!t.value.longitude){i.warning("请在地图上选择位置");return}V.value=!0;try{const a=_.value?`/api/admin/checkin-points/${t.value.id}`:"/api/admin/checkin-points",e=_.value?"PUT":"POST",r=await(await fetch(a,{method:e,headers:{"Content-Type":"application/json"},body:JSON.stringify({...t.value,user_id:x()})})).json();r.success?(i.success(_.value?"更新成功":"添加成功"),g.value=!1,T()):i.error(r.message||"操作失败")}catch(a){console.error("提交失败:",a),i.error("操作失败")}finally{V.value=!1}},q=async a=>{try{await ne.confirm("确定要删除这个签到点吗？","提示",{type:"warning"});const u=await(await fetch(`/api/admin/checkin-points/${a.id}?user_id=${x()}`,{method:"DELETE"})).json();u.success?(i.success("删除成功"),T()):i.error(u.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),i.error("删除失败"))}};return Y(()=>{T(),z()}),(a,e)=>{const u=s("Plus"),r=s("el-icon"),c=s("el-button"),v=s("el-table-column"),J=s("el-tag"),K=s("el-table"),A=s("el-card"),U=s("el-input"),b=s("el-form-item"),G=s("el-slider"),R=s("el-option"),W=s("el-select"),Z=s("el-form"),H=s("el-dialog"),Q=ee("loading");return C(),$("div",re,[d("div",ue,[e[7]||(e[7]=d("h2",null,"签到点管理",-1)),l(c,{type:"primary",onClick:I},{default:n(()=>[l(r,null,{default:n(()=>[l(u)]),_:1}),e[6]||(e[6]=p(" 添加签到点 ",-1))]),_:1})]),l(A,null,{default:n(()=>[te((C(),D(K,{data:S.value,stripe:""},{default:n(()=>[l(v,{prop:"id",label:"ID",width:"60"}),l(v,{prop:"name",label:"名称","min-width":"150"}),l(v,{label:"位置","min-width":"200"},{default:n(({row:o})=>[d("span",de,h(o.latitude)+", "+h(o.longitude),1)]),_:1}),l(v,{prop:"radius",label:"有效半径",width:"100"},{default:n(({row:o})=>[p(h(o.radius)+"米 ",1)]),_:1}),l(v,{prop:"school_name",label:"所属学校",width:"150"}),l(v,{prop:"status",label:"状态",width:"80"},{default:n(({row:o})=>[l(J,{type:o.status==="active"?"success":"info"},{default:n(()=>[p(h(o.status==="active"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(v,{label:"操作",width:"150",fixed:"right"},{default:n(({row:o})=>[l(c,{size:"small",onClick:X=>N(o)},{default:n(()=>[...e[8]||(e[8]=[p("编辑",-1)])]),_:1},8,["onClick"]),l(c,{size:"small",type:"danger",onClick:X=>q(o)},{default:n(()=>[...e[9]||(e[9]=[p("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Q,M.value]])]),_:1}),l(H,{modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=o=>g.value=o),title:_.value?"编辑签到点":"添加签到点",width:"700px",onOpened:P,onClosed:j},{footer:n(()=>[l(c,{onClick:e[4]||(e[4]=o=>g.value=!1)},{default:n(()=>[...e[15]||(e[15]=[p("取消",-1)])]),_:1}),l(c,{type:"primary",onClick:O,loading:V.value},{default:n(()=>[...e[16]||(e[16]=[p("确定",-1)])]),_:1},8,["loading"])]),default:n(()=>[l(Z,{model:t.value,"label-width":"100px"},{default:n(()=>[l(b,{label:"名称",required:""},{default:n(()=>[l(U,{modelValue:t.value.name,"onUpdate:modelValue":e[0]||(e[0]=o=>t.value.name=o),placeholder:"如：体育馆乒乓球室"},null,8,["modelValue"])]),_:1}),l(b,{label:"搜索地址"},{default:n(()=>[l(U,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=o=>w.value=o),placeholder:"输入地址搜索，如：浙江工业大学体育馆",onKeyup:le(E,["enter"])},{append:n(()=>[l(c,{onClick:E},{default:n(()=>[...e[10]||(e[10]=[p("搜索",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(b,{label:"地图选点"},{default:n(()=>[...e[11]||(e[11]=[d("div",{class:"map-container",id:"mapContainer"},[d("div",{class:"map-tip"},"点击地图选择位置")],-1)])]),_:1}),l(b,{label:"已选坐标"},{default:n(()=>[d("div",ce,[d("span",null,[e[12]||(e[12]=p("纬度: ",-1)),d("strong",null,h(t.value.latitude||"未选择"),1)]),d("span",pe,[e[13]||(e[13]=p("经度: ",-1)),d("strong",null,h(t.value.longitude||"未选择"),1)])])]),_:1}),l(b,{label:"有效半径"},{default:n(()=>[l(G,{modelValue:t.value.radius,"onUpdate:modelValue":e[2]||(e[2]=o=>t.value.radius=o),min:10,max:500,step:10,"show-input":"",onChange:B},null,8,["modelValue"]),e[14]||(e[14]=d("span",{class:"radius-hint"},"用户需在此范围内才能签到",-1))]),_:1}),l(b,{label:"所属学校"},{default:n(()=>[l(W,{modelValue:t.value.school_id,"onUpdate:modelValue":e[3]||(e[3]=o=>t.value.school_id=o),clearable:"",placeholder:"请选择（可选）"},{default:n(()=>[(C(!0),$(ae,null,oe(F.value,o=>(C(),D(R,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},_e=ie(me,[["__scopeId","data-v-8fad70ef"]]);export{_e as default};
