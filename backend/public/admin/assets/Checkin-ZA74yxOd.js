import{_ as L}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r,p as A,c as U,o as g,b as k,d as l,w as a,f as s,E as u,q as G,h as m,s as H,l as E,t as K,F as Q,v as R,z as W}from"./index-BhydzvWF.js";const X={class:"page"},Y={class:"page-header"},Z={__name:"Checkin",setup(ee){const b=r(!1),C=r([]),x=r([]),d=r(!1),c=r(!1),y=r(!1),o=r({name:"",latitude:"",longitude:"",radius:100,school_id:null}),w=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,V=async()=>{b.value=!0;try{const e=await(await fetch(`/api/admin/checkin-points?user_id=${w()}`)).json();e.success&&(C.value=e.data||[])}catch(n){console.error("加载签到点失败:",n),u.error("加载失败")}finally{b.value=!1}},P=async()=>{try{const e=await(await fetch("/api/common/schools")).json();e.success&&(x.value=e.data||[])}catch(n){console.error("加载学校失败:",n)}},$=()=>{c.value=!1,o.value={name:"",latitude:"",longitude:"",radius:100,school_id:null},d.value=!0},D=n=>{c.value=!0,o.value={...n},d.value=!0},S=async()=>{if(!o.value.name||!o.value.latitude||!o.value.longitude){u.warning("请填写名称和坐标");return}y.value=!0;try{const n=c.value?`/api/admin/checkin-points/${o.value.id}`:"/api/admin/checkin-points",e=c.value?"PUT":"POST",v=await(await fetch(n,{method:e,headers:{"Content-Type":"application/json"},body:JSON.stringify({...o.value,user_id:w()})})).json();v.success?(u.success(c.value?"更新成功":"添加成功"),d.value=!1,V()):u.error(v.message||"操作失败")}catch(n){console.error("提交失败:",n),u.error("操作失败")}finally{y.value=!1}},j=async n=>{try{await W.confirm("确定要删除这个签到点吗？","提示",{type:"warning"});const p=await(await fetch(`/api/admin/checkin-points/${n.id}?user_id=${w()}`,{method:"DELETE"})).json();p.success?(u.success("删除成功"),V()):u.error(p.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),u.error("删除失败"))}};return A(()=>{V(),P()}),(n,e)=>{const p=s("Plus"),v=s("el-icon"),_=s("el-button"),i=s("el-table-column"),B=s("el-tag"),N=s("el-table"),T=s("el-card"),h=s("el-input"),f=s("el-form-item"),q=s("el-input-number"),I=s("el-option"),z=s("el-select"),F=s("el-form"),M=s("el-dialog"),O=G("loading");return g(),U("div",X,[k("div",Y,[e[8]||(e[8]=k("h2",null,"签到点管理",-1)),l(_,{type:"primary",onClick:$},{default:a(()=>[l(v,null,{default:a(()=>[l(p)]),_:1}),e[7]||(e[7]=m(" 添加签到点 ",-1))]),_:1})]),l(T,null,{default:a(()=>[H((g(),E(N,{data:C.value,stripe:""},{default:a(()=>[l(i,{prop:"id",label:"ID",width:"60"}),l(i,{prop:"name",label:"名称","min-width":"150"}),l(i,{prop:"latitude",label:"纬度",width:"120"}),l(i,{prop:"longitude",label:"经度",width:"120"}),l(i,{prop:"radius",label:"有效半径(米)",width:"120"}),l(i,{prop:"school_name",label:"所属学校",width:"150"}),l(i,{prop:"status",label:"状态",width:"80"},{default:a(({row:t})=>[l(B,{type:t.status==="active"?"success":"info"},{default:a(()=>[m(K(t.status==="active"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(i,{label:"操作",width:"150",fixed:"right"},{default:a(({row:t})=>[l(_,{size:"small",onClick:J=>D(t)},{default:a(()=>[...e[9]||(e[9]=[m("编辑",-1)])]),_:1},8,["onClick"]),l(_,{size:"small",type:"danger",onClick:J=>j(t)},{default:a(()=>[...e[10]||(e[10]=[m("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[O,b.value]])]),_:1}),l(M,{modelValue:d.value,"onUpdate:modelValue":e[6]||(e[6]=t=>d.value=t),title:c.value?"编辑签到点":"添加签到点",width:"500px"},{footer:a(()=>[l(_,{onClick:e[5]||(e[5]=t=>d.value=!1)},{default:a(()=>[...e[12]||(e[12]=[m("取消",-1)])]),_:1}),l(_,{type:"primary",onClick:S,loading:y.value},{default:a(()=>[...e[13]||(e[13]=[m("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(F,{model:o.value,"label-width":"100px"},{default:a(()=>[l(f,{label:"名称",required:""},{default:a(()=>[l(h,{modelValue:o.value.name,"onUpdate:modelValue":e[0]||(e[0]=t=>o.value.name=t),placeholder:"如：体育馆一楼"},null,8,["modelValue"])]),_:1}),l(f,{label:"纬度",required:""},{default:a(()=>[l(h,{modelValue:o.value.latitude,"onUpdate:modelValue":e[1]||(e[1]=t=>o.value.latitude=t),placeholder:"如：30.123456"},null,8,["modelValue"])]),_:1}),l(f,{label:"经度",required:""},{default:a(()=>[l(h,{modelValue:o.value.longitude,"onUpdate:modelValue":e[2]||(e[2]=t=>o.value.longitude=t),placeholder:"如：120.123456"},null,8,["modelValue"])]),_:1}),l(f,{label:"有效半径"},{default:a(()=>[l(q,{modelValue:o.value.radius,"onUpdate:modelValue":e[3]||(e[3]=t=>o.value.radius=t),min:10,max:1e3},null,8,["modelValue"]),e[11]||(e[11]=k("span",{style:{"margin-left":"10px",color:"#999"}},"米",-1))]),_:1}),l(f,{label:"所属学校"},{default:a(()=>[l(z,{modelValue:o.value.school_id,"onUpdate:modelValue":e[4]||(e[4]=t=>o.value.school_id=t),clearable:"",placeholder:"请选择"},{default:a(()=>[(g(!0),U(Q,null,R(x.value,t=>(g(),E(I,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},ae=L(Z,[["__scopeId","data-v-8bcdd4e2"]]);export{ae as default};
