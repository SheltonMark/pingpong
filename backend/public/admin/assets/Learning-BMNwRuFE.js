import{_ as ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as u,i as le,p as te,c as L,o as h,b as T,d as l,w as t,f as s,E as r,q as ae,h as i,s as oe,l as ne,t as w,k as se,z as re}from"./index-DQr7_rPk.js";const ie={class:"page"},ue={class:"page-header"},de={key:0,class:"current-file"},pe={__name:"Learning",setup(ce){const V=u(!1),x=u([]),v=u("video"),c=u(!1),m=u(!1),k=u(!1),N=u(null),g=u([]),n=u({title:"",type:"video",url:"",original_name:"",description:""}),$={video:"视频",ppt:"PPT",document:"文档"},S={video:"danger",ppt:"warning",document:""},C=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,j=le(()=>"/api/upload/file"),M=a=>a?(a.startsWith("http"),a):"",q=a=>a.size/1024/1024<100?!0:(r.error("文件大小不能超过 100MB"),!1),z=a=>{a.success?(n.value.url=a.data.url,n.value.original_name=a.data.originalName,r.success("文件上传成功")):r.error(a.message||"上传失败")},I=()=>{r.error("文件上传失败")},b=async()=>{V.value=!0;try{const e=await(await fetch(`/api/admin/learning?user_id=${C()}`)).json();if(e.success){const p=e.data||[];x.value=p.filter(f=>f.type===v.value)}}catch(a){console.error("加载学习资料失败:",a),r.error("加载失败")}finally{V.value=!1}},F=()=>{m.value=!1,n.value={title:"",type:v.value,url:"",original_name:"",description:""},g.value=[],c.value=!0},O=a=>{m.value=!0,n.value={...a},g.value=[],c.value=!0},J=async()=>{if(!n.value.title){r.warning("请填写标题");return}if(!n.value.url){r.warning("请上传文件");return}k.value=!0;try{const a=m.value?`/api/admin/learning/${n.value.id}`:"/api/admin/learning",e=m.value?"PUT":"POST",f=await(await fetch(a,{method:e,headers:{"Content-Type":"application/json"},body:JSON.stringify({...n.value,user_id:C()})})).json();f.success?(r.success(m.value?"更新成功":"添加成功"),c.value=!1,b()):r.error(f.message||"操作失败")}catch(a){console.error("提交失败:",a),r.error("操作失败")}finally{k.value=!1}},R=async a=>{try{await re.confirm("确定要删除这个资料吗？","提示",{type:"warning"});const p=await(await fetch(`/api/admin/learning/${a.id}?user_id=${C()}`,{method:"DELETE"})).json();p.success?(r.success("删除成功"),b()):r.error(p.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),r.error("删除失败"))}};return te(()=>{b()}),(a,e)=>{const p=s("Plus"),f=s("el-icon"),_=s("el-button"),P=s("el-tab-pane"),W=s("el-tabs"),d=s("el-table-column"),E=s("el-tag"),B=s("el-link"),A=s("el-table"),G=s("el-card"),D=s("el-input"),y=s("el-form-item"),U=s("el-option"),H=s("el-select"),K=s("el-upload"),Q=s("el-form"),X=s("el-dialog"),Y=ae("loading");return h(),L("div",ie,[T("div",ue,[e[7]||(e[7]=T("h2",null,"学习资料管理",-1)),l(_,{type:"primary",onClick:F},{default:t(()=>[l(f,null,{default:t(()=>[l(p)]),_:1}),e[6]||(e[6]=i(" 添加资料 ",-1))]),_:1})]),l(G,null,{default:t(()=>[l(W,{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=o=>v.value=o),onTabChange:b},{default:t(()=>[l(P,{label:"视频",name:"video"}),l(P,{label:"PPT",name:"ppt"}),l(P,{label:"文档",name:"document"})]),_:1},8,["modelValue"]),oe((h(),ne(A,{data:x.value,stripe:""},{default:t(()=>[l(d,{prop:"id",label:"ID",width:"60"}),l(d,{prop:"title",label:"标题","min-width":"200"}),l(d,{prop:"type",label:"类型",width:"100"},{default:t(({row:o})=>[l(E,{type:S[o.type]},{default:t(()=>[i(w($[o.type]),1)]),_:2},1032,["type"])]),_:1}),l(d,{label:"文件","min-width":"200"},{default:t(({row:o})=>[l(B,{href:M(o.url),target:"_blank",type:"primary"},{default:t(()=>[i(w(o.original_name||"查看文件"),1)]),_:2},1032,["href"])]),_:1}),l(d,{prop:"view_count",label:"浏览量",width:"80"}),l(d,{prop:"status",label:"状态",width:"80"},{default:t(({row:o})=>[l(E,{type:o.status==="active"?"success":"info"},{default:t(()=>[i(w(o.status==="active"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(d,{prop:"created_at",label:"创建时间",width:"160"}),l(d,{label:"操作",width:"150",fixed:"right"},{default:t(({row:o})=>[l(_,{size:"small",onClick:Z=>O(o)},{default:t(()=>[...e[8]||(e[8]=[i("编辑",-1)])]),_:1},8,["onClick"]),l(_,{size:"small",type:"danger",onClick:Z=>R(o)},{default:t(()=>[...e[9]||(e[9]=[i("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Y,V.value]])]),_:1}),l(X,{modelValue:c.value,"onUpdate:modelValue":e[5]||(e[5]=o=>c.value=o),title:m.value?"编辑资料":"添加资料",width:"500px"},{footer:t(()=>[l(_,{onClick:e[4]||(e[4]=o=>c.value=!1)},{default:t(()=>[...e[13]||(e[13]=[i("取消",-1)])]),_:1}),l(_,{type:"primary",onClick:J,loading:k.value},{default:t(()=>[...e[14]||(e[14]=[i("确定",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(Q,{model:n.value,"label-width":"80px"},{default:t(()=>[l(y,{label:"标题",required:""},{default:t(()=>[l(D,{modelValue:n.value.title,"onUpdate:modelValue":e[1]||(e[1]=o=>n.value.title=o),placeholder:"请输入资料标题"},null,8,["modelValue"])]),_:1}),l(y,{label:"类型",required:""},{default:t(()=>[l(H,{modelValue:n.value.type,"onUpdate:modelValue":e[2]||(e[2]=o=>n.value.type=o),placeholder:"请选择类型"},{default:t(()=>[l(U,{label:"视频",value:"video"}),l(U,{label:"PPT",value:"ppt"}),l(U,{label:"文档",value:"document"})]),_:1},8,["modelValue"])]),_:1}),l(y,{label:"上传文件",required:""},{default:t(()=>[l(K,{ref_key:"uploadRef",ref:N,class:"upload-demo",action:j.value,limit:1,"on-success":z,"on-error":I,"before-upload":q,"file-list":g.value,"auto-upload":!0,name:"file"},{tip:t(()=>[...e[11]||(e[11]=[T("div",{class:"el-upload__tip"}," 支持视频、PPT、PDF、Word文档，最大100MB ",-1)])]),default:t(()=>[l(_,{type:"primary"},{default:t(()=>[...e[10]||(e[10]=[i("选择文件",-1)])]),_:1})]),_:1},8,["action","file-list"]),n.value.url&&!g.value.length?(h(),L("div",de,[e[12]||(e[12]=i(" 当前文件：",-1)),l(B,{href:M(n.value.url),target:"_blank",type:"primary"},{default:t(()=>[i(w(n.value.original_name||"查看"),1)]),_:1},8,["href"])])):se("",!0)]),_:1}),l(y,{label:"描述"},{default:t(()=>[l(D,{modelValue:n.value.description,"onUpdate:modelValue":e[3]||(e[3]=o=>n.value.description=o),type:"textarea",rows:3,placeholder:"请输入资料描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},_e=ee(pe,[["__scopeId","data-v-40d4dcac"]]);export{_e as default};
