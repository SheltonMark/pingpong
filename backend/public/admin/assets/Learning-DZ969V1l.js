import{f as ne}from"./format-JQP6GPa6.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as d,i as re,p as ie,c as V,o as _,b,d as t,w as l,f as r,E as s,q as ue,h as i,s as de,l as S,t as y,m as pe,k as $,z as ce}from"./index-CSMk-Sui.js";const me={class:"page"},fe={class:"page-header"},ve={class:"el-upload__tip"},_e={key:0,class:"current-file"},ye=["src"],ge={key:1,class:"cover-placeholder"},be={__name:"Learning",setup(Pe){const k=d(!1),M=d([]),P=d("video"),m=d(!1),f=d(!1),C=d(!1),I=d(null),w=d([]),o=d({title:"",type:"video",url:"",original_name:"",description:"",cover_url:""}),j={video:"视频",document:"PDF",ppt:"PPT"},q={video:"danger",document:"",ppt:"warning"},z={video:"video/*",document:"application/pdf",ppt:".ppt,.pptx,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation"},W={video:"支持 MP4、AVI 等视频格式",document:"仅支持 PDF 文件",ppt:"支持 PPT、PPTX 文件"},x=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,h=re(()=>"/api/upload/file"),E=a=>a?(a.startsWith("http"),a):"",O=a=>{if(!(a.size/1024/1024<100))return s.error("文件大小不能超过 100MB"),!1;if(o.value.type==="video"){if(!a.type.startsWith("video/"))return s.error("请上传视频文件"),!1}else if(o.value.type==="document"){if(a.type!=="application/pdf")return s.error("请上传 PDF 文件"),!1}else if(o.value.type==="ppt"&&!(["application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(a.type)||a.name.endsWith(".ppt")||a.name.endsWith(".pptx")))return s.error("请上传 PPT 或 PPTX 文件"),!1;return!0},J=a=>{a.success?(o.value.url=a.data.url,o.value.original_name=a.data.originalName,s.success("文件上传成功")):s.error(a.message||"上传失败")},R=()=>{s.error("文件上传失败")},X=a=>{a.success?(o.value.cover_url=a.data.url,s.success("封面上传成功")):s.error(a.message||"上传失败")},T=async()=>{k.value=!0;try{const e=await(await fetch(`/api/admin/learning?user_id=${x()}`)).json();if(e.success){const u=e.data||[];M.value=u.filter(p=>p.type===P.value)}}catch(a){console.error("加载学习资料失败:",a),s.error("加载失败")}finally{k.value=!1}},A=()=>{f.value=!1,o.value={title:"",type:P.value,url:"",original_name:"",description:"",cover_url:""},w.value=[],m.value=!0},G=a=>{f.value=!0,o.value={...a},w.value=[],m.value=!0},H=async()=>{if(!o.value.title){s.warning("请填写标题");return}if(!o.value.url){s.warning("请上传文件");return}C.value=!0;try{const a=f.value?`/api/admin/learning/${o.value.id}`:"/api/admin/learning",e=f.value?"PUT":"POST",p=await(await fetch(a,{method:e,headers:{"Content-Type":"application/json"},body:JSON.stringify({...o.value,user_id:x()})})).json();p.success?(s.success(f.value?"更新成功":"添加成功"),m.value=!1,T()):s.error(p.message||"操作失败")}catch(a){console.error("提交失败:",a),s.error("操作失败")}finally{C.value=!1}},K=async a=>{try{await ce.confirm("确定要删除这个资料吗？","提示",{type:"warning"});const u=await(await fetch(`/api/admin/learning/${a.id}?user_id=${x()}`,{method:"DELETE"})).json();u.success?(s.success("删除成功"),T()):s.error(u.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),s.error("删除失败"))}};return ie(()=>{T()}),(a,e)=>{const u=r("Plus"),p=r("el-icon"),v=r("el-button"),U=r("el-tab-pane"),Q=r("el-tabs"),c=r("el-table-column"),B=r("el-tag"),F=r("el-link"),Y=r("el-table"),Z=r("el-card"),L=r("el-input"),g=r("el-form-item"),D=r("el-radio"),ee=r("el-radio-group"),N=r("el-upload"),te=r("el-form"),le=r("el-dialog"),ae=ue("loading");return _(),V("div",me,[b("div",fe,[e[7]||(e[7]=b("h2",null,"学习资料管理",-1)),t(v,{type:"primary",onClick:A},{default:l(()=>[t(p,null,{default:l(()=>[t(u)]),_:1}),e[6]||(e[6]=i(" 添加资料 ",-1))]),_:1})]),t(Z,null,{default:l(()=>[t(Q,{modelValue:P.value,"onUpdate:modelValue":e[0]||(e[0]=n=>P.value=n),onTabChange:T},{default:l(()=>[t(U,{label:"教学视频",name:"video"}),t(U,{label:"PDF文档",name:"document"}),t(U,{label:"PPT课件",name:"ppt"})]),_:1},8,["modelValue"]),de((_(),S(Y,{data:M.value,stripe:""},{default:l(()=>[t(c,{prop:"id",label:"ID",width:"60"}),t(c,{prop:"title",label:"标题","min-width":"200"}),t(c,{prop:"type",label:"类型",width:"100"},{default:l(({row:n})=>[t(B,{type:q[n.type]},{default:l(()=>[i(y(j[n.type]),1)]),_:2},1032,["type"])]),_:1}),t(c,{label:"文件","min-width":"200"},{default:l(({row:n})=>[t(F,{href:E(n.url),target:"_blank",type:"primary"},{default:l(()=>[i(y(n.original_name||"查看文件"),1)]),_:2},1032,["href"])]),_:1}),t(c,{prop:"view_count",label:"浏览量",width:"80"}),t(c,{prop:"status",label:"状态",width:"80"},{default:l(({row:n})=>[t(B,{type:n.status==="active"?"success":"info"},{default:l(()=>[i(y(n.status==="active"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),t(c,{label:"创建时间",width:"160"},{default:l(({row:n})=>[i(y(pe(ne)(n.created_at)),1)]),_:1}),t(c,{label:"操作",width:"150",fixed:"right"},{default:l(({row:n})=>[t(v,{size:"small",onClick:oe=>G(n)},{default:l(()=>[...e[8]||(e[8]=[i("编辑",-1)])]),_:1},8,["onClick"]),t(v,{size:"small",type:"danger",onClick:oe=>K(n)},{default:l(()=>[...e[9]||(e[9]=[i("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ae,k.value]])]),_:1}),t(le,{modelValue:m.value,"onUpdate:modelValue":e[5]||(e[5]=n=>m.value=n),title:f.value?"编辑资料":"添加资料",width:"500px"},{footer:l(()=>[t(v,{onClick:e[4]||(e[4]=n=>m.value=!1)},{default:l(()=>[...e[17]||(e[17]=[i("取消",-1)])]),_:1}),t(v,{type:"primary",onClick:H,loading:C.value},{default:l(()=>[...e[18]||(e[18]=[i("确定",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(te,{model:o.value,"label-width":"80px"},{default:l(()=>[t(g,{label:"标题",required:""},{default:l(()=>[t(L,{modelValue:o.value.title,"onUpdate:modelValue":e[1]||(e[1]=n=>o.value.title=n),placeholder:"请输入资料标题"},null,8,["modelValue"])]),_:1}),t(g,{label:"类型",required:""},{default:l(()=>[t(ee,{modelValue:o.value.type,"onUpdate:modelValue":e[2]||(e[2]=n=>o.value.type=n)},{default:l(()=>[t(D,{value:"video"},{default:l(()=>[...e[10]||(e[10]=[i("教学视频",-1)])]),_:1}),t(D,{value:"document"},{default:l(()=>[...e[11]||(e[11]=[i("PDF文档",-1)])]),_:1}),t(D,{value:"ppt"},{default:l(()=>[...e[12]||(e[12]=[i("PPT课件",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(g,{label:"上传文件",required:""},{default:l(()=>[t(N,{ref_key:"uploadRef",ref:I,class:"upload-demo",action:h.value,limit:1,"on-success":J,"on-error":R,"before-upload":O,"file-list":w.value,"auto-upload":!0,accept:z[o.value.type],name:"file"},{tip:l(()=>[b("div",ve,y(W[o.value.type])+"，最大100MB ",1)]),default:l(()=>[t(v,{type:"primary"},{default:l(()=>[...e[13]||(e[13]=[i("选择文件",-1)])]),_:1})]),_:1},8,["action","file-list","accept"]),o.value.url&&!w.value.length?(_(),V("div",_e,[e[14]||(e[14]=i(" 当前文件：",-1)),t(F,{href:E(o.value.url),target:"_blank",type:"primary"},{default:l(()=>[i(y(o.value.original_name||"查看"),1)]),_:1},8,["href"])])):$("",!0)]),_:1}),t(g,{label:"描述"},{default:l(()=>[t(L,{modelValue:o.value.description,"onUpdate:modelValue":e[3]||(e[3]=n=>o.value.description=n),type:"textarea",rows:3,placeholder:"请输入资料描述（可选）"},null,8,["modelValue"])]),_:1}),o.value.type==="video"?(_(),S(g,{key:0,label:"视频封面"},{default:l(()=>[t(N,{class:"cover-uploader",action:h.value,"show-file-list":!1,"on-success":X,accept:"image/*",name:"file"},{default:l(()=>[o.value.cover_url?(_(),V("img",{key:0,src:o.value.cover_url,class:"cover-preview"},null,8,ye)):(_(),V("div",ge,[t(p,null,{default:l(()=>[t(u)]),_:1}),e[15]||(e[15]=b("span",null,"上传封面",-1))]))]),_:1},8,["action"]),e[16]||(e[16]=b("div",{class:"cover-tip"},"建议尺寸 16:9，用于视频列表展示",-1))]),_:1})):$("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},ke=se(be,[["__scopeId","data-v-e5faf673"]]);export{ke as default};
