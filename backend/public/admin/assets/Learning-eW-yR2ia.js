import{f as se}from"./format-DoeqoNZs.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as p,i as ie,p as ue,c as V,o as _,b,d as t,w as a,f as r,E as s,q as de,h as i,s as pe,l as $,t as y,m as ce,k as I,G as me}from"./index-Bxrtwine.js";const fe={class:"page"},ve={class:"page-header"},_e={class:"el-upload__tip"},ye={key:0,class:"current-file"},ge=["src"],be={key:1,class:"cover-placeholder"},we={__name:"Learning",setup(Pe){const k=p(!1),M=p([]),w=p("video"),m=p(!1),f=p(!1),h=p(!1),W=p(null),P=p([]),o=p({title:"",type:"video",url:"",original_name:"",description:"",cover_url:""}),j={video:"视频",document:"PDF",ppt:"PPT"},q={video:"danger",document:"",ppt:"warning"},z={video:"video/*",document:"application/pdf",ppt:".ppt,.pptx,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation"},O={video:"支持 MP4、AVI 等视频格式",document:"仅支持 PDF 文件",ppt:"支持 PPT、PPTX 文件"},C=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,E=ie(()=>"/api/upload/file"),x=l=>l?l.startsWith("http")?l:window.location.origin+l:"",B=l=>{if(!l)return l;if(l.startsWith("http")){const e=l.match(/\/uploads\/[^?#]+/);if(e)return e[0]}return l},R=l=>{if(!(l.size/1024/1024<100))return s.error("文件大小不能超过 100MB"),!1;if(o.value.type==="video"){if(!l.type.startsWith("video/"))return s.error("请上传视频文件"),!1}else if(o.value.type==="document"){if(l.type!=="application/pdf")return s.error("请上传 PDF 文件"),!1}else if(o.value.type==="ppt"&&!(["application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(l.type)||l.name.endsWith(".ppt")||l.name.endsWith(".pptx")))return s.error("请上传 PPT 或 PPTX 文件"),!1;return!0},J=l=>{l.success?(o.value.url=l.data.url,o.value.original_name=l.data.originalName,s.success("文件上传成功")):s.error(l.message||"上传失败")},X=()=>{s.error("文件上传失败")},A=l=>{l.success?(o.value.cover_url=l.data.url,s.success("封面上传成功")):s.error(l.message||"上传失败")},T=async()=>{k.value=!0;try{const e=await(await fetch(`/api/admin/learning?user_id=${C()}`)).json();if(e.success){const u=e.data||[];M.value=u.filter(v=>v.type===w.value)}}catch(l){console.error("加载学习资料失败:",l),s.error("加载失败")}finally{k.value=!1}},G=()=>{f.value=!1,o.value={title:"",type:w.value,url:"",original_name:"",description:"",cover_url:""},P.value=[],m.value=!0},H=l=>{f.value=!0,o.value={...l},P.value=[],m.value=!0},K=async()=>{if(!o.value.title){s.warning("请填写标题");return}if(!o.value.url){s.warning("请上传文件");return}h.value=!0;try{const l=f.value?`/api/admin/learning/${o.value.id}`:"/api/admin/learning",e=f.value?"PUT":"POST",u={...o.value,url:B(o.value.url),cover_url:B(o.value.cover_url),user_id:C()},d=await(await fetch(l,{method:e,headers:{"Content-Type":"application/json"},body:JSON.stringify(u)})).json();d.success?(s.success(f.value?"更新成功":"添加成功"),m.value=!1,T()):s.error(d.message||"操作失败")}catch(l){console.error("提交失败:",l),s.error("操作失败")}finally{h.value=!1}},Q=async l=>{try{await me.confirm("确定要删除这个资料吗？","提示",{type:"warning"});const u=await(await fetch(`/api/admin/learning/${l.id}?user_id=${C()}`,{method:"DELETE"})).json();u.success?(s.success("删除成功"),T()):s.error(u.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),s.error("删除失败"))}};return ue(()=>{T()}),(l,e)=>{const u=r("Plus"),v=r("el-icon"),d=r("el-button"),U=r("el-tab-pane"),Y=r("el-tabs"),c=r("el-table-column"),F=r("el-tag"),L=r("el-link"),Z=r("el-table"),ee=r("el-card"),N=r("el-input"),g=r("el-form-item"),D=r("el-radio"),te=r("el-radio-group"),S=r("el-upload"),le=r("el-form"),ae=r("el-dialog"),oe=de("loading");return _(),V("div",fe,[b("div",ve,[e[7]||(e[7]=b("h2",null,"学习资料管理",-1)),t(d,{type:"primary",onClick:G},{default:a(()=>[t(v,null,{default:a(()=>[t(u)]),_:1}),e[6]||(e[6]=i(" 添加资料 ",-1))]),_:1})]),t(ee,null,{default:a(()=>[t(Y,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=n=>w.value=n),onTabChange:T},{default:a(()=>[t(U,{label:"教学视频",name:"video"}),t(U,{label:"PDF文档",name:"document"}),t(U,{label:"PPT课件",name:"ppt"})]),_:1},8,["modelValue"]),pe((_(),$(Z,{data:M.value,stripe:""},{default:a(()=>[t(c,{prop:"id",label:"ID",width:"60"}),t(c,{prop:"title",label:"标题","min-width":"200"}),t(c,{prop:"type",label:"类型",width:"100"},{default:a(({row:n})=>[t(F,{type:q[n.type]},{default:a(()=>[i(y(j[n.type]),1)]),_:2},1032,["type"])]),_:1}),t(c,{label:"文件","min-width":"200"},{default:a(({row:n})=>[t(L,{href:x(n.url),target:"_blank",type:"primary"},{default:a(()=>[i(y(n.original_name||"查看文件"),1)]),_:2},1032,["href"])]),_:1}),t(c,{prop:"view_count",label:"浏览量",width:"80"}),t(c,{prop:"status",label:"状态",width:"80"},{default:a(({row:n})=>[t(F,{type:n.status==="active"?"success":"info"},{default:a(()=>[i(y(n.status==="active"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),t(c,{label:"创建时间",width:"160"},{default:a(({row:n})=>[i(y(ce(se)(n.created_at)),1)]),_:1}),t(c,{label:"操作",width:"150",fixed:"right"},{default:a(({row:n})=>[t(d,{size:"small",onClick:ne=>H(n)},{default:a(()=>[...e[8]||(e[8]=[i("编辑",-1)])]),_:1},8,["onClick"]),t(d,{size:"small",type:"danger",onClick:ne=>Q(n)},{default:a(()=>[...e[9]||(e[9]=[i("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[oe,k.value]])]),_:1}),t(ae,{modelValue:m.value,"onUpdate:modelValue":e[5]||(e[5]=n=>m.value=n),title:f.value?"编辑资料":"添加资料",width:"500px"},{footer:a(()=>[t(d,{onClick:e[4]||(e[4]=n=>m.value=!1)},{default:a(()=>[...e[17]||(e[17]=[i("取消",-1)])]),_:1}),t(d,{type:"primary",onClick:K,loading:h.value},{default:a(()=>[...e[18]||(e[18]=[i("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[t(le,{model:o.value,"label-width":"80px"},{default:a(()=>[t(g,{label:"标题",required:""},{default:a(()=>[t(N,{modelValue:o.value.title,"onUpdate:modelValue":e[1]||(e[1]=n=>o.value.title=n),placeholder:"请输入资料标题"},null,8,["modelValue"])]),_:1}),t(g,{label:"类型",required:""},{default:a(()=>[t(te,{modelValue:o.value.type,"onUpdate:modelValue":e[2]||(e[2]=n=>o.value.type=n)},{default:a(()=>[t(D,{value:"video"},{default:a(()=>[...e[10]||(e[10]=[i("教学视频",-1)])]),_:1}),t(D,{value:"document"},{default:a(()=>[...e[11]||(e[11]=[i("PDF文档",-1)])]),_:1}),t(D,{value:"ppt"},{default:a(()=>[...e[12]||(e[12]=[i("PPT课件",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(g,{label:"上传文件",required:""},{default:a(()=>[t(S,{ref_key:"uploadRef",ref:W,class:"upload-demo",action:E.value,limit:1,"on-success":J,"on-error":X,"before-upload":R,"file-list":P.value,"auto-upload":!0,accept:z[o.value.type],name:"file"},{tip:a(()=>[b("div",_e,y(O[o.value.type])+"，最大100MB ",1)]),default:a(()=>[t(d,{type:"primary"},{default:a(()=>[...e[13]||(e[13]=[i("选择文件",-1)])]),_:1})]),_:1},8,["action","file-list","accept"]),o.value.url&&!P.value.length?(_(),V("div",ye,[e[14]||(e[14]=i(" 当前文件：",-1)),t(L,{href:x(o.value.url),target:"_blank",type:"primary"},{default:a(()=>[i(y(o.value.original_name||"查看"),1)]),_:1},8,["href"])])):I("",!0)]),_:1}),t(g,{label:"描述"},{default:a(()=>[t(N,{modelValue:o.value.description,"onUpdate:modelValue":e[3]||(e[3]=n=>o.value.description=n),type:"textarea",rows:3,placeholder:"请输入资料描述（可选）"},null,8,["modelValue"])]),_:1}),o.value.type==="video"?(_(),$(g,{key:0,label:"视频封面"},{default:a(()=>[t(S,{class:"cover-uploader",action:E.value,"show-file-list":!1,"on-success":A,accept:"image/*",name:"file"},{default:a(()=>[o.value.cover_url?(_(),V("img",{key:0,src:x(o.value.cover_url),class:"cover-preview"},null,8,ge)):(_(),V("div",be,[t(v,null,{default:a(()=>[t(u)]),_:1}),e[15]||(e[15]=b("span",null,"上传封面",-1))]))]),_:1},8,["action"]),e[16]||(e[16]=b("div",{class:"cover-tip"},"建议尺寸 16:9，用于视频列表展示",-1))]),_:1})):I("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},he=re(we,[["__scopeId","data-v-74d5c19c"]]);export{he as default};
