import{f as J}from"./format-DoeqoNZs.js";import{_ as O}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as w,a as $,p as q,c as z,o as d,b as u,d as s,w as l,f as i,E as g,q as G,F as R,v as A,l as f,s as H,t as h,k as V,h as _,m as K,G as Q}from"./index-BvkG0U9F.js";const W={class:"page"},X={class:"page-header"},Y={class:"filters"},Z={class:"author-cell"},ee={class:"content-cell"},te={class:"content-text"},ae={key:0,class:"image-count"},se={class:"pagination"},le={__name:"Posts",setup(oe){const b=w(!1),S=w([]),P=w([]),r=$({status:"",school_id:""}),c=$({page:1,limit:20,total:0}),y=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,p=async()=>{b.value=!0;try{const a=new URLSearchParams({user_id:y(),page:c.page,limit:c.limit});r.status&&a.append("status",r.status),r.school_id&&a.append("school_id",r.school_id);const n=await(await fetch(`/api/admin/posts?${a}`)).json();n.success?(S.value=n.data.list||[],c.total=n.data.total||0):g.error(n.message||"加载失败")}catch(a){console.error("加载帖子失败:",a),g.error("加载失败")}finally{b.value=!1}},x=async()=>{try{const t=await(await fetch(`/api/admin/schools?user_id=${y()}`)).json();t.success&&(P.value=t.data||[])}catch(a){console.error("加载学校列表失败:",a)}},k=async(a,t)=>{const m={active:"启用",hidden:"隐藏",deleted:"删除"}[t];try{await Q.confirm(`确定要${m}这条帖子吗？`,"提示",{type:t==="deleted"?"warning":"info"});const v=await(await fetch(`/api/admin/posts/${a.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:t,user_id:y()})})).json();v.success?(g.success(`已${m}`),p()):g.error(v.message||"操作失败")}catch(o){o!=="cancel"&&(console.error("更新状态失败:",o),g.error("操作失败"))}},N=a=>({active:"success",hidden:"warning",deleted:"danger"})[a]||"info",T=a=>({active:"启用",hidden:"隐藏",deleted:"已删除"})[a]||a,B=(a,t)=>a?a.length<=t?a:a.substring(0,t)+"...":"";return q(()=>{p(),x()}),(a,t)=>{const n=i("el-option"),m=i("el-select"),o=i("el-table-column"),v=i("el-avatar"),D=i("Picture"),j=i("el-icon"),E=i("el-tag"),C=i("el-button"),I=i("el-table"),L=i("el-pagination"),M=i("el-card"),F=G("loading");return d(),z("div",W,[u("div",X,[t[4]||(t[4]=u("h2",null,"帖子管理",-1)),u("div",Y,[s(m,{modelValue:r.status,"onUpdate:modelValue":t[0]||(t[0]=e=>r.status=e),placeholder:"状态筛选",clearable:"",onChange:p},{default:l(()=>[s(n,{label:"全部",value:""}),s(n,{label:"启用",value:"active"}),s(n,{label:"隐藏",value:"hidden"}),s(n,{label:"已删除",value:"deleted"})]),_:1},8,["modelValue"]),s(m,{modelValue:r.school_id,"onUpdate:modelValue":t[1]||(t[1]=e=>r.school_id=e),placeholder:"学校筛选",clearable:"",onChange:p},{default:l(()=>[(d(!0),z(R,null,A(P.value,e=>(d(),f(n,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),s(M,null,{default:l(()=>[H((d(),f(I,{data:S.value,stripe:""},{default:l(()=>[s(o,{prop:"id",label:"ID",width:"60"}),s(o,{label:"作者",width:"150"},{default:l(({row:e})=>[u("div",Z,[s(v,{src:e.author_avatar,size:32},null,8,["src"]),u("span",null,h(e.author_name||"未知用户"),1)])]),_:1}),s(o,{prop:"content",label:"内容","min-width":"300"},{default:l(({row:e})=>[u("div",ee,[u("p",te,h(B(e.content,100)),1),e.images&&e.images.length?(d(),z("div",ae,[s(j,null,{default:l(()=>[s(D)]),_:1}),_(" "+h(e.images.length)+" 张图片 ",1)])):V("",!0)])]),_:1}),s(o,{prop:"school_name",label:"学校",width:"120"}),s(o,{prop:"status",label:"状态",width:"80"},{default:l(({row:e})=>[s(E,{type:N(e.status)},{default:l(()=>[_(h(T(e.status)),1)]),_:2},1032,["type"])]),_:1}),s(o,{prop:"like_count",label:"点赞",width:"70"}),s(o,{prop:"comment_count",label:"评论",width:"70"}),s(o,{prop:"created_at",label:"发布时间",width:"160"},{default:l(({row:e})=>[_(h(K(J)(e.created_at)),1)]),_:1}),s(o,{label:"操作",width:"150",fixed:"right"},{default:l(({row:e})=>[e.status==="active"?(d(),f(C,{key:0,size:"small",type:"warning",onClick:U=>k(e,"hidden")},{default:l(()=>[...t[5]||(t[5]=[_(" 隐藏 ",-1)])]),_:1},8,["onClick"])):e.status==="hidden"?(d(),f(C,{key:1,size:"small",type:"success",onClick:U=>k(e,"active")},{default:l(()=>[...t[6]||(t[6]=[_(" 启用 ",-1)])]),_:1},8,["onClick"])):V("",!0),e.status!=="deleted"?(d(),f(C,{key:2,size:"small",type:"danger",onClick:U=>k(e,"deleted")},{default:l(()=>[...t[7]||(t[7]=[_(" 删除 ",-1)])]),_:1},8,["onClick"])):V("",!0)]),_:1})]),_:1},8,["data"])),[[F,b.value]]),u("div",se,[s(L,{"current-page":c.page,"onUpdate:currentPage":t[2]||(t[2]=e=>c.page=e),"page-size":c.limit,"onUpdate:pageSize":t[3]||(t[3]=e=>c.limit=e),total:c.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:p,onCurrentChange:p},null,8,["current-page","page-size","total"])])]),_:1})])}}},ce=O(le,[["__scopeId","data-v-e7de39df"]]);export{ce as default};
