import{f as J}from"./format-DoeqoNZs.js";import{_ as O}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as V,a as x,p as q,c as w,o as c,b as p,d as a,w as l,f as r,E as f,q as G,F as R,v as A,l as v,s as H,t as g,k as z,h as _,m as K,G as Q}from"./index-DAJtp09M.js";const W={class:"page"},X={class:"page-header"},Y={class:"filters"},Z={class:"author-cell"},ee={class:"content-cell"},te={class:"content-text"},ae={key:0,class:"image-count"},se={class:"pagination"},le={__name:"Posts",setup(oe){const b=V(!1),S=V([]),U=V([]),i=x({post_type:"",status:"",school_id:""}),d=x({page:1,limit:20,total:0}),y=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,u=async()=>{b.value=!0;try{const s=new URLSearchParams({user_id:y(),page:d.page,limit:d.limit});i.post_type&&s.append("post_type",i.post_type),i.status&&s.append("status",i.status),i.school_id&&s.append("school_id",i.school_id);const o=await(await fetch(`/api/admin/posts?${s}`)).json();o.success?(S.value=o.data.list||[],d.total=o.data.total||0):f.error(o.message||"加载失败")}catch(s){console.error("加载帖子失败:",s),f.error("加载失败")}finally{b.value=!1}},N=async()=>{try{const t=await(await fetch(`/api/admin/schools?user_id=${y()}`)).json();t.success&&(U.value=t.data||[])}catch(s){console.error("加载学校列表失败:",s)}},k=async(s,t)=>{const m={active:"启用",hidden:"隐藏",deleted:"删除"}[t];try{await Q.confirm(`确定要${m}这条帖子吗？`,"提示",{type:t==="deleted"?"warning":"info"});const h=await(await fetch(`/api/admin/posts/${s.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:t,user_id:y()})})).json();h.success?(f.success(`已${m}`),u()):f.error(h.message||"操作失败")}catch(n){n!=="cancel"&&(console.error("更新状态失败:",n),f.error("操作失败"))}},T=s=>({active:"success",hidden:"warning",deleted:"danger"})[s]||"info",B=s=>({active:"启用",hidden:"隐藏",deleted:"已删除"})[s]||s,D=(s,t)=>s?s.length<=t?s:s.substring(0,t)+"...":"";return q(()=>{u(),N()}),(s,t)=>{const o=r("el-option"),m=r("el-select"),n=r("el-table-column"),h=r("el-avatar"),j=r("Picture"),E=r("el-icon"),P=r("el-tag"),C=r("el-button"),I=r("el-table"),L=r("el-pagination"),M=r("el-card"),F=G("loading");return c(),w("div",W,[p("div",X,[t[5]||(t[5]=p("h2",null,"帖子管理",-1)),p("div",Y,[a(m,{modelValue:i.post_type,"onUpdate:modelValue":t[0]||(t[0]=e=>i.post_type=e),placeholder:"类型筛选",clearable:"",onChange:u},{default:l(()=>[a(o,{label:"全部类型",value:""}),a(o,{label:"普通帖子",value:"post"}),a(o,{label:"约球帖子",value:"invitation"})]),_:1},8,["modelValue"]),a(m,{modelValue:i.status,"onUpdate:modelValue":t[1]||(t[1]=e=>i.status=e),placeholder:"状态筛选",clearable:"",onChange:u},{default:l(()=>[a(o,{label:"全部状态",value:""}),a(o,{label:"启用",value:"active"}),a(o,{label:"隐藏",value:"hidden"}),a(o,{label:"已删除",value:"deleted"})]),_:1},8,["modelValue"]),a(m,{modelValue:i.school_id,"onUpdate:modelValue":t[2]||(t[2]=e=>i.school_id=e),placeholder:"学校筛选",clearable:"",filterable:"",onChange:u,teleported:!0},{default:l(()=>[(c(!0),w(R,null,A(U.value,e=>(c(),v(o,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),a(M,null,{default:l(()=>[H((c(),v(I,{data:S.value,stripe:""},{default:l(()=>[a(n,{prop:"id",label:"ID",width:"60"}),a(n,{label:"作者",width:"150"},{default:l(({row:e})=>[p("div",Z,[a(h,{src:e.author_avatar,size:32},null,8,["src"]),p("span",null,g(e.author_name||"未知用户"),1)])]),_:1}),a(n,{prop:"content",label:"内容","min-width":"300"},{default:l(({row:e})=>[p("div",ee,[p("p",te,g(D(e.content,100)),1),e.images&&e.images.length?(c(),w("div",ae,[a(E,null,{default:l(()=>[a(j)]),_:1}),_(" "+g(e.images.length)+" 张图片 ",1)])):z("",!0)])]),_:1}),a(n,{prop:"school_name",label:"学校",width:"120"}),a(n,{label:"类型",width:"90"},{default:l(({row:e})=>[a(P,{type:e.post_type==="invitation"?"warning":"primary",size:"small"},{default:l(()=>[_(g(e.post_type==="invitation"?"约球":"帖子"),1)]),_:2},1032,["type"])]),_:1}),a(n,{prop:"status",label:"状态",width:"80"},{default:l(({row:e})=>[a(P,{type:T(e.status)},{default:l(()=>[_(g(B(e.status)),1)]),_:2},1032,["type"])]),_:1}),a(n,{prop:"like_count",label:"点赞",width:"70"}),a(n,{prop:"comment_count",label:"评论",width:"70"}),a(n,{prop:"created_at",label:"发布时间",width:"160"},{default:l(({row:e})=>[_(g(K(J)(e.created_at)),1)]),_:1}),a(n,{label:"操作",width:"150",fixed:"right"},{default:l(({row:e})=>[e.status==="active"?(c(),v(C,{key:0,size:"small",type:"warning",onClick:$=>k(e,"hidden")},{default:l(()=>[...t[6]||(t[6]=[_(" 隐藏 ",-1)])]),_:1},8,["onClick"])):e.status==="hidden"?(c(),v(C,{key:1,size:"small",type:"success",onClick:$=>k(e,"active")},{default:l(()=>[...t[7]||(t[7]=[_(" 启用 ",-1)])]),_:1},8,["onClick"])):z("",!0),e.status!=="deleted"?(c(),v(C,{key:2,size:"small",type:"danger",onClick:$=>k(e,"deleted")},{default:l(()=>[...t[8]||(t[8]=[_(" 删除 ",-1)])]),_:1},8,["onClick"])):z("",!0)]),_:1})]),_:1},8,["data"])),[[F,b.value]]),p("div",se,[a(L,{"current-page":d.page,"onUpdate:currentPage":t[3]||(t[3]=e=>d.page=e),"page-size":d.limit,"onUpdate:pageSize":t[4]||(t[4]=e=>d.limit=e),total:d.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:u,onCurrentChange:u},null,8,["current-page","page-size","total"])])]),_:1})])}}},de=O(le,[["__scopeId","data-v-d1544fc2"]]);export{de as default};
