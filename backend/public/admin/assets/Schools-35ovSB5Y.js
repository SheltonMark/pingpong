import{_ as Q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as d,i as W,a as X,B as Y,p as Z,c as k,o as m,d as t,w as s,f as n,q as ee,s as le,l as C,b as y,t as S,h as p,k as te,F as T,v as j,G as ae,E as v}from"./index-V-KHXU_L.js";const oe={class:"schools-page"},se={class:"card-header"},ne={__name:"Schools",setup(re){const g=d(!1),b=d(!1),x=d([]),h=d(!1),c=d(!1),u=d(null),$=d(null),F=["浙江省","江苏省","上海市","安徽省","福建省","广东省","北京市","天津市","其他"],U={浙江省:["杭州市","宁波市","温州市","嘉兴市","湖州市","绍兴市","金华市","衢州市","舟山市","台州市","丽水市"],江苏省:["南京市","苏州市","无锡市","常州市","南通市","扬州市","镇江市","泰州市","盐城市","淮安市","连云港市","徐州市","宿迁市"],上海市:["上海市"],安徽省:["合肥市","芜湖市","蚌埠市","淮南市","马鞍山市","淮北市","铜陵市","安庆市","黄山市","阜阳市","宿州市","滁州市","六安市","宣城市","池州市","亳州市"],福建省:["福州市","厦门市","莆田市","三明市","泉州市","漳州市","南平市","龙岩市","宁德市"],广东省:["广州市","深圳市","珠海市","汕头市","佛山市","韶关市","湛江市","肇庆市","江门市","茂名市","惠州市","梅州市","汕尾市","河源市","阳江市","清远市","东莞市","中山市","潮州市","揭阳市","云浮市"],北京市:["北京市"],天津市:["天津市"],其他:["其他"]},I=W(()=>U[a.province]||[]),L=()=>{const o=U[a.province];o&&o.length>0?a.city=o[0]:a.city=""},a=X({name:"",short_name:"",province:"浙江省",city:"杭州市",is_active:!0}),P={name:[{required:!0,message:"请输入学校名称",trigger:"blur"}]},w=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,V=async()=>{g.value=!0;try{const e=await(await fetch(`/api/admin/schools?user_id=${w()}&include_inactive=1`)).json();e.success&&(x.value=e.data)}catch(o){console.error("Load schools error:",o)}finally{g.value=!1}},E=()=>{a.name="",a.short_name="",a.province="浙江省",a.city="杭州市",a.is_active=!0,u.value=null},z=o=>{u.value=o,a.name=o.name,a.short_name=o.short_name||"",a.province=o.province||"",a.city=o.city||"",a.is_active=!!o.is_active,c.value=!0},M=async()=>{if(await $.value.validate().catch(()=>!1)){b.value=!0;try{const e=u.value?`/api/admin/schools/${u.value.id}`:"/api/admin/schools",r=u.value?"PUT":"POST",f=await(await fetch(e,{method:r,headers:{"Content-Type":"application/json"},body:JSON.stringify({...a,user_id:w()})})).json();f.success?(v.success(u.value?"更新成功":"添加成功"),c.value=!1,E(),V()):v.error(f.message||"操作失败")}catch(e){console.error("Submit error:",e),v.error("操作失败")}finally{b.value=!1}}},O=async o=>{try{await ae.confirm(o.user_count>0?`该学校有 ${o.user_count} 个用户，删除后将改为禁用状态。确定继续？`:`确定要删除 ${o.name} 吗？`,"确认删除",{type:"warning"});const r=await(await fetch(`/api/admin/schools/${o.id}?user_id=${w()}`,{method:"DELETE"})).json();r.success?(v.success(r.message||"已删除"),V()):v.error(r.message||"删除失败")}catch{}};return Y(h,o=>{o&&(E(),c.value=!0,h.value=!1)}),Z(()=>{V()}),(o,e)=>{const r=n("el-button"),i=n("el-table-column"),f=n("el-tag"),q=n("el-table"),J=n("el-card"),B=n("el-input"),_=n("el-form-item"),D=n("el-option"),N=n("el-select"),R=n("el-switch"),A=n("el-form"),G=n("el-dialog"),H=ee("loading");return m(),k("div",oe,[t(J,null,{header:s(()=>[y("div",se,[e[9]||(e[9]=y("span",null,"学校管理",-1)),t(r,{type:"primary",onClick:e[0]||(e[0]=l=>h.value=!0)},{default:s(()=>[...e[8]||(e[8]=[p("添加学校",-1)])]),_:1})])]),default:s(()=>[le((m(),C(q,{data:x.value,stripe:""},{default:s(()=>[t(i,{prop:"id",label:"ID",width:"80"}),t(i,{prop:"name",label:"学校名称"}),t(i,{prop:"short_name",label:"简称",width:"120"}),t(i,{prop:"province",label:"省份",width:"100"}),t(i,{prop:"city",label:"城市",width:"100"}),t(i,{label:"用户数",width:"100"},{default:s(({row:l})=>[y("span",null,S(l.user_count||0),1)]),_:1}),t(i,{label:"管理员",width:"100"},{default:s(({row:l})=>[y("span",null,S(l.admin_count||0),1)]),_:1}),t(i,{label:"状态",width:"80"},{default:s(({row:l})=>[t(f,{type:l.is_active?"success":"info",size:"small"},{default:s(()=>[p(S(l.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),t(i,{label:"操作",width:"150"},{default:s(({row:l})=>[t(r,{size:"small",onClick:K=>z(l)},{default:s(()=>[...e[10]||(e[10]=[p("编辑",-1)])]),_:1},8,["onClick"]),t(r,{size:"small",type:"danger",onClick:K=>O(l)},{default:s(()=>[...e[11]||(e[11]=[p("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[H,g.value]])]),_:1}),t(G,{modelValue:c.value,"onUpdate:modelValue":e[7]||(e[7]=l=>c.value=l),title:u.value?"编辑学校":"添加学校",width:"500px"},{footer:s(()=>[t(r,{onClick:e[6]||(e[6]=l=>c.value=!1)},{default:s(()=>[...e[12]||(e[12]=[p("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:M,loading:b.value},{default:s(()=>[...e[13]||(e[13]=[p("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[t(A,{model:a,rules:P,ref_key:"formRef",ref:$,"label-width":"100px"},{default:s(()=>[t(_,{label:"学校名称",prop:"name"},{default:s(()=>[t(B,{modelValue:a.name,"onUpdate:modelValue":e[1]||(e[1]=l=>a.name=l),placeholder:"请输入完整学校名称"},null,8,["modelValue"])]),_:1}),t(_,{label:"简称",prop:"short_name"},{default:s(()=>[t(B,{modelValue:a.short_name,"onUpdate:modelValue":e[2]||(e[2]=l=>a.short_name=l),placeholder:"如：浙大、复旦"},null,8,["modelValue"])]),_:1}),t(_,{label:"省份"},{default:s(()=>[t(N,{modelValue:a.province,"onUpdate:modelValue":e[3]||(e[3]=l=>a.province=l),placeholder:"请选择省份",onChange:L},{default:s(()=>[(m(),k(T,null,j(F,l=>t(D,{key:l,label:l,value:l},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(_,{label:"城市"},{default:s(()=>[t(N,{modelValue:a.city,"onUpdate:modelValue":e[4]||(e[4]=l=>a.city=l),placeholder:"请选择城市"},{default:s(()=>[(m(!0),k(T,null,j(I.value,l=>(m(),C(D,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u.value?(m(),C(_,{key:0,label:"状态"},{default:s(()=>[t(R,{modelValue:a.is_active,"onUpdate:modelValue":e[5]||(e[5]=l=>a.is_active=l),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})):te("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},de=Q(ne,[["__scopeId","data-v-fec406cf"]]);export{de as default};
