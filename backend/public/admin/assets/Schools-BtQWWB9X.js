import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as d,a as A,A as F,p as J,c as P,o as k,d as l,w as o,f as i,q as R,s as G,l as U,b as g,t as C,h as m,k as H,z as K,E as _}from"./index-wZSs7Alf.js";const Q={class:"schools-page"},W={class:"card-header"},X={__name:"Schools",setup(Y){const y=d(!1),b=d(!1),S=d([]),w=d(!1),c=d(!1),u=d(null),x=d(null),a=A({name:"",short_name:"",province:"",city:"",is_active:!0}),E={name:[{required:!0,message:"请输入学校名称",trigger:"blur"}]},h=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,V=async()=>{y.value=!0;try{const e=await(await fetch(`/api/admin/schools?user_id=${h()}&include_inactive=1`)).json();e.success&&(S.value=e.data)}catch(s){console.error("Load schools error:",s)}finally{y.value=!1}},$=()=>{a.name="",a.short_name="",a.province="",a.city="",a.is_active=!0,u.value=null},D=s=>{u.value=s,a.name=s.name,a.short_name=s.short_name||"",a.province=s.province||"",a.city=s.city||"",a.is_active=!!s.is_active,c.value=!0},N=async()=>{if(await x.value.validate().catch(()=>!1)){b.value=!0;try{const e=u.value?`/api/admin/schools/${u.value.id}`:"/api/admin/schools",n=u.value?"PUT":"POST",f=await(await fetch(e,{method:n,headers:{"Content-Type":"application/json"},body:JSON.stringify({...a,user_id:h()})})).json();f.success?(_.success(u.value?"更新成功":"添加成功"),c.value=!1,$(),V()):_.error(f.message||"操作失败")}catch(e){console.error("Submit error:",e),_.error("操作失败")}finally{b.value=!1}}},B=async s=>{try{await K.confirm(s.user_count>0?`该学校有 ${s.user_count} 个用户，删除后将改为禁用状态。确定继续？`:`确定要删除 ${s.name} 吗？`,"确认删除",{type:"warning"});const n=await(await fetch(`/api/admin/schools/${s.id}?user_id=${h()}`,{method:"DELETE"})).json();n.success?(_.success(n.message||"已删除"),V()):_.error(n.message||"删除失败")}catch{}};return F(w,s=>{s&&($(),c.value=!0,w.value=!1)}),J(()=>{V()}),(s,e)=>{const n=i("el-button"),r=i("el-table-column"),f=i("el-tag"),T=i("el-table"),j=i("el-card"),v=i("el-input"),p=i("el-form-item"),z=i("el-switch"),I=i("el-form"),L=i("el-dialog"),M=R("loading");return k(),P("div",Q,[l(j,null,{header:o(()=>[g("div",W,[e[9]||(e[9]=g("span",null,"学校管理",-1)),l(n,{type:"primary",onClick:e[0]||(e[0]=t=>w.value=!0)},{default:o(()=>[...e[8]||(e[8]=[m("添加学校",-1)])]),_:1})])]),default:o(()=>[G((k(),U(T,{data:S.value,stripe:""},{default:o(()=>[l(r,{prop:"id",label:"ID",width:"80"}),l(r,{prop:"name",label:"学校名称"}),l(r,{prop:"short_name",label:"简称",width:"120"}),l(r,{prop:"province",label:"省份",width:"100"}),l(r,{prop:"city",label:"城市",width:"100"}),l(r,{label:"用户数",width:"100"},{default:o(({row:t})=>[g("span",null,C(t.user_count||0),1)]),_:1}),l(r,{label:"管理员",width:"100"},{default:o(({row:t})=>[g("span",null,C(t.admin_count||0),1)]),_:1}),l(r,{label:"状态",width:"80"},{default:o(({row:t})=>[l(f,{type:t.is_active?"success":"info",size:"small"},{default:o(()=>[m(C(t.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(r,{label:"操作",width:"150"},{default:o(({row:t})=>[l(n,{size:"small",onClick:O=>D(t)},{default:o(()=>[...e[10]||(e[10]=[m("编辑",-1)])]),_:1},8,["onClick"]),l(n,{size:"small",type:"danger",onClick:O=>B(t)},{default:o(()=>[...e[11]||(e[11]=[m("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[M,y.value]])]),_:1}),l(L,{modelValue:c.value,"onUpdate:modelValue":e[7]||(e[7]=t=>c.value=t),title:u.value?"编辑学校":"添加学校",width:"500px"},{footer:o(()=>[l(n,{onClick:e[6]||(e[6]=t=>c.value=!1)},{default:o(()=>[...e[12]||(e[12]=[m("取消",-1)])]),_:1}),l(n,{type:"primary",onClick:N,loading:b.value},{default:o(()=>[...e[13]||(e[13]=[m("确定",-1)])]),_:1},8,["loading"])]),default:o(()=>[l(I,{model:a,rules:E,ref_key:"formRef",ref:x,"label-width":"100px"},{default:o(()=>[l(p,{label:"学校名称",prop:"name"},{default:o(()=>[l(v,{modelValue:a.name,"onUpdate:modelValue":e[1]||(e[1]=t=>a.name=t),placeholder:"请输入完整学校名称"},null,8,["modelValue"])]),_:1}),l(p,{label:"简称",prop:"short_name"},{default:o(()=>[l(v,{modelValue:a.short_name,"onUpdate:modelValue":e[2]||(e[2]=t=>a.short_name=t),placeholder:"如：浙大、复旦"},null,8,["modelValue"])]),_:1}),l(p,{label:"省份"},{default:o(()=>[l(v,{modelValue:a.province,"onUpdate:modelValue":e[3]||(e[3]=t=>a.province=t),placeholder:"如：浙江省"},null,8,["modelValue"])]),_:1}),l(p,{label:"城市"},{default:o(()=>[l(v,{modelValue:a.city,"onUpdate:modelValue":e[4]||(e[4]=t=>a.city=t),placeholder:"如：杭州市"},null,8,["modelValue"])]),_:1}),u.value?(k(),U(p,{key:0,label:"状态"},{default:o(()=>[l(z,{modelValue:a.is_active,"onUpdate:modelValue":e[5]||(e[5]=t=>a.is_active=t),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})):H("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},le=q(X,[["__scopeId","data-v-343c6271"]]);export{le as default};
