import{r as i,i as ge,a as he,B as we,p as be,c as p,o as r,d as s,w as a,f as c,q as Ce,s as ee,l as x,b as v,t as E,h as m,k as F,g as J,F as k,v as K,y as ke,G as le,E as u}from"./index-CvYCLO8z.js";import{_ as Ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const $e={class:"schools-page"},Se={class:"card-header"},Ue={class:"college-drawer-content"},xe={class:"add-college-form"},Ee={class:"college-list"},ze={key:0,class:"empty-tip"},je={key:1,class:"college-items"},De={class:"college-info"},Ne={class:"college-name"},Te={class:"college-meta"},Ie={class:"user-count"},Be={class:"college-actions"},Le={key:0,class:"show-inactive-toggle"},Oe={__name:"Schools",setup(Pe){const D=i(!1),N=i(!1),M=i([]),T=i(!1),b=i(!1),f=i(null),A=i(null),I=i(!1),h=i(null),B=i([]),L=i(!1),w=i(!1),V=i(""),z=i(null),C=i(""),$=i(!1),q=i(!1),te=["浙江省","江苏省","上海市","安徽省","福建省","广东省","北京市","天津市","其他"],G={浙江省:["杭州市","宁波市","温州市","嘉兴市","湖州市","绍兴市","金华市","衢州市","舟山市","台州市","丽水市"],江苏省:["南京市","苏州市","无锡市","常州市","南通市","扬州市","镇江市","泰州市","盐城市","淮安市","连云港市","徐州市","宿迁市"],上海市:["上海市"],安徽省:["合肥市","芜湖市","蚌埠市","淮南市","马鞍山市","淮北市","铜陵市","安庆市","黄山市","阜阳市","宿州市","滁州市","六安市","宣城市","池州市","亳州市"],福建省:["福州市","厦门市","莆田市","三明市","泉州市","漳州市","南平市","龙岩市","宁德市"],广东省:["广州市","深圳市","珠海市","汕头市","佛山市","韶关市","湛江市","肇庆市","江门市","茂名市","惠州市","梅州市","汕尾市","河源市","阳江市","清远市","东莞市","中山市","潮州市","揭阳市","云浮市"],北京市:["北京市"],天津市:["天津市"],其他:["其他"]},se=ge(()=>G[o.province]||[]),ae=()=>{const t=G[o.province];t&&t.length>0?o.city=t[0]:o.city=""},o=he({name:"",short_name:"",province:"浙江省",city:"杭州市",is_active:!0}),oe={name:[{required:!0,message:"请输入学校名称",trigger:"blur"}]},_=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,O=async()=>{D.value=!0;try{const e=await(await fetch(`/api/admin/schools?user_id=${_()}&include_inactive=1`)).json();e.success&&(M.value=e.data)}catch(t){console.error("Load schools error:",t)}finally{D.value=!1}},H=()=>{o.name="",o.short_name="",o.province="浙江省",o.city="杭州市",o.is_active=!0,f.value=null},ne=t=>{f.value=t,o.name=t.name,o.short_name=t.short_name||"",o.province=t.province||"",o.city=t.city||"",o.is_active=!!t.is_active,b.value=!0},ie=async()=>{if(await A.value.validate().catch(()=>!1)){N.value=!0;try{const e=f.value?`/api/admin/schools/${f.value.id}`:"/api/admin/schools",n=f.value?"PUT":"POST",y=await(await fetch(e,{method:n,headers:{"Content-Type":"application/json"},body:JSON.stringify({...o,user_id:_()})})).json();y.success?(u.success(f.value?"更新成功":"添加成功"),b.value=!1,H(),O()):u.error(y.message||"操作失败")}catch(e){console.error("Submit error:",e),u.error("操作失败")}finally{N.value=!1}}},re=async t=>{try{await le.confirm(t.user_count>0?`该学校有 ${t.user_count} 个用户，删除后将改为禁用状态。确定继续？`:`确定要删除 ${t.name} 吗？`,"确认删除",{type:"warning"});const n=await(await fetch(`/api/admin/schools/${t.id}?user_id=${_()}`,{method:"DELETE"})).json();n.success?(u.success(n.message||"已删除"),O()):u.error(n.message||"删除失败")}catch{}},ue=t=>{h.value=t,I.value=!0,$.value=!1,S()},S=async()=>{if(h.value){L.value=!0;try{const t=$.value?"1":"",n=await(await fetch(`/api/admin/schools/${h.value.id}/colleges?user_id=${_()}&include_inactive=${t}`)).json();if(n.success&&(B.value=n.data,!$.value)){const y=await(await fetch(`/api/admin/schools/${h.value.id}/colleges?user_id=${_()}&include_inactive=1`)).json();y.success&&(q.value=y.data.some(R=>!R.is_active))}}catch(t){console.error("Load colleges error:",t),u.error("加载学院列表失败")}finally{L.value=!1}}},Q=async()=>{if(!V.value.trim()){u.warning("请输入学院名称");return}w.value=!0;try{const e=await(await fetch(`/api/admin/schools/${h.value.id}/colleges`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:V.value.trim(),user_id:_()})})).json();e.success?(u.success("添加成功"),V.value="",S()):u.error(e.message||"添加失败")}catch(t){console.error("Add college error:",t),u.error("添加失败")}finally{w.value=!1}},de=t=>{z.value=t.id,C.value=t.name},P=()=>{z.value=null,C.value=""},W=async t=>{if(!C.value.trim()){u.warning("学院名称不能为空");return}w.value=!0;try{const n=await(await fetch(`/api/admin/colleges/${t.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:C.value.trim(),is_active:t.is_active,user_id:_()})})).json();n.success?(u.success("更新成功"),P(),S()):u.error(n.message||"更新失败")}catch(e){console.error("Update college error:",e),u.error("更新失败")}finally{w.value=!1}},ce=async t=>{try{const e=t.user_count>0?`该学院有 ${t.user_count} 个用户，删除后将改为禁用状态。确定继续？`:`确定要删除「${t.name}」吗？`;await le.confirm(e,"确认删除",{type:"warning"});const d=await(await fetch(`/api/admin/colleges/${t.id}?user_id=${_()}`,{method:"DELETE"})).json();d.success?(u.success(d.message||"已删除"),S()):u.error(d.message||"删除失败")}catch{}};return we(T,t=>{t&&(H(),b.value=!0,T.value=!1)}),be(()=>{O()}),(t,e)=>{const n=c("el-button"),d=c("el-table-column"),y=c("el-tag"),R=c("el-table"),me=c("el-card"),j=c("el-input"),pe=c("el-checkbox"),ve=c("el-drawer"),U=c("el-form-item"),X=c("el-option"),Y=c("el-select"),fe=c("el-switch"),_e=c("el-form"),ye=c("el-dialog"),Z=Ce("loading");return r(),p("div",$e,[s(me,null,{header:a(()=>[v("div",Se,[e[13]||(e[13]=v("span",null,"学校管理",-1)),s(n,{type:"primary",onClick:e[0]||(e[0]=l=>T.value=!0)},{default:a(()=>[...e[12]||(e[12]=[m("添加学校",-1)])]),_:1})])]),default:a(()=>[ee((r(),x(R,{data:M.value,stripe:""},{default:a(()=>[s(d,{prop:"id",label:"ID",width:"80"}),s(d,{prop:"name",label:"学校名称"}),s(d,{prop:"short_name",label:"简称",width:"120"}),s(d,{prop:"province",label:"省份",width:"100"}),s(d,{prop:"city",label:"城市",width:"100"}),s(d,{label:"用户数",width:"100"},{default:a(({row:l})=>[v("span",null,E(l.user_count||0),1)]),_:1}),s(d,{label:"管理员",width:"100"},{default:a(({row:l})=>[v("span",null,E(l.admin_count||0),1)]),_:1}),s(d,{label:"状态",width:"80"},{default:a(({row:l})=>[s(y,{type:l.is_active?"success":"info",size:"small"},{default:a(()=>[m(E(l.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),s(d,{label:"操作",width:"240"},{default:a(({row:l})=>[s(n,{size:"small",type:"primary",onClick:g=>ue(l)},{default:a(()=>[...e[14]||(e[14]=[m("管理学院",-1)])]),_:1},8,["onClick"]),s(n,{size:"small",onClick:g=>ne(l)},{default:a(()=>[...e[15]||(e[15]=[m("编辑",-1)])]),_:1},8,["onClick"]),s(n,{size:"small",type:"danger",onClick:g=>re(l)},{default:a(()=>[...e[16]||(e[16]=[m("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Z,D.value]])]),_:1}),s(ve,{modelValue:I.value,"onUpdate:modelValue":e[4]||(e[4]=l=>I.value=l),title:h.value?`${h.value.name} - 学院管理`:"学院管理",direction:"rtl",size:"450px"},{default:a(()=>[v("div",Ue,[v("div",xe,[s(j,{modelValue:V.value,"onUpdate:modelValue":e[1]||(e[1]=l=>V.value=l),placeholder:"输入新学院名称",onKeyup:J(Q,["enter"]),disabled:w.value},{append:a(()=>[s(n,{type:"primary",onClick:Q,loading:w.value},{default:a(()=>[...e[17]||(e[17]=[m(" 添加 ",-1)])]),_:1},8,["loading"])]),_:1},8,["modelValue","disabled"])]),ee((r(),p("div",Ee,[B.value.length===0?(r(),p("div",ze," 暂无学院，请添加 ")):(r(),p("div",je,[(r(!0),p(k,null,K(B.value,l=>(r(),p("div",{key:l.id,class:ke(["college-item",{inactive:!l.is_active}])},[v("div",De,[z.value===l.id?(r(),x(j,{key:0,modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=g=>C.value=g),size:"small",onKeyup:[J(g=>W(l),["enter"]),J(P,["esc"])]},null,8,["modelValue","onKeyup"])):(r(),p(k,{key:1},[v("span",Ne,E(l.name),1),l.is_active?F("",!0):(r(),x(y,{key:0,size:"small",type:"info",class:"status-tag"},{default:a(()=>[...e[18]||(e[18]=[m("已禁用",-1)])]),_:1}))],64))]),v("div",Te,[v("span",Ie,E(l.user_count||0)+" 人",1)]),v("div",Be,[z.value===l.id?(r(),p(k,{key:0},[s(n,{size:"small",type:"primary",onClick:g=>W(l),loading:w.value},{default:a(()=>[...e[19]||(e[19]=[m(" 保存 ",-1)])]),_:1},8,["onClick","loading"]),s(n,{size:"small",onClick:P},{default:a(()=>[...e[20]||(e[20]=[m("取消",-1)])]),_:1})],64)):(r(),p(k,{key:1},[s(n,{size:"small",text:"",type:"primary",onClick:g=>de(l)},{default:a(()=>[...e[21]||(e[21]=[m("编辑",-1)])]),_:1},8,["onClick"]),s(n,{size:"small",text:"",type:"danger",onClick:g=>ce(l)},{default:a(()=>[...e[22]||(e[22]=[m("删除",-1)])]),_:1},8,["onClick"])],64))])],2))),128))]))])),[[Z,L.value]]),q.value?(r(),p("div",Le,[s(pe,{modelValue:$.value,"onUpdate:modelValue":e[3]||(e[3]=l=>$.value=l),onChange:S},{default:a(()=>[...e[23]||(e[23]=[m(" 显示已禁用的学院 ",-1)])]),_:1},8,["modelValue"])])):F("",!0)])]),_:1},8,["modelValue","title"]),s(ye,{modelValue:b.value,"onUpdate:modelValue":e[11]||(e[11]=l=>b.value=l),title:f.value?"编辑学校":"添加学校",width:"500px"},{footer:a(()=>[s(n,{onClick:e[10]||(e[10]=l=>b.value=!1)},{default:a(()=>[...e[24]||(e[24]=[m("取消",-1)])]),_:1}),s(n,{type:"primary",onClick:ie,loading:N.value},{default:a(()=>[...e[25]||(e[25]=[m("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[s(_e,{model:o,rules:oe,ref_key:"formRef",ref:A,"label-width":"100px"},{default:a(()=>[s(U,{label:"学校名称",prop:"name"},{default:a(()=>[s(j,{modelValue:o.name,"onUpdate:modelValue":e[5]||(e[5]=l=>o.name=l),placeholder:"请输入完整学校名称"},null,8,["modelValue"])]),_:1}),s(U,{label:"简称",prop:"short_name"},{default:a(()=>[s(j,{modelValue:o.short_name,"onUpdate:modelValue":e[6]||(e[6]=l=>o.short_name=l),placeholder:"如：浙大、复旦"},null,8,["modelValue"])]),_:1}),s(U,{label:"省份"},{default:a(()=>[s(Y,{modelValue:o.province,"onUpdate:modelValue":e[7]||(e[7]=l=>o.province=l),placeholder:"请选择省份",onChange:ae},{default:a(()=>[(r(),p(k,null,K(te,l=>s(X,{key:l,label:l,value:l},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),s(U,{label:"城市"},{default:a(()=>[s(Y,{modelValue:o.city,"onUpdate:modelValue":e[8]||(e[8]=l=>o.city=l),placeholder:"请选择城市"},{default:a(()=>[(r(!0),p(k,null,K(se.value,l=>(r(),x(X,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),f.value?(r(),x(U,{key:0,label:"状态"},{default:a(()=>[s(fe,{modelValue:o.is_active,"onUpdate:modelValue":e[9]||(e[9]=l=>o.is_active=l),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})):F("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Je=Ve(Oe,[["__scopeId","data-v-8b77e97b"]]);export{Je as default};
