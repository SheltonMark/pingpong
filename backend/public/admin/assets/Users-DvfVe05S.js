import{r as u,p as Q,c as W,o as _,b as c,d as l,w as a,f as n,E as i,q as X,s as Y,l as V,k as Z,g as ee,h as d,t as h}from"./index-B_huGCKR.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ae={class:"page"},te={class:"search-bar"},oe={__name:"Users",setup(ne){const j=u(!1),x=u([]),w=u(1),U=u(0),C=u(""),f=u(!1),g=u(!1),b=u(!1),p=u({id:null,name:"",role:""}),s=u({id:null,name:"",currentRating:0,adjustment:0,remark:""}),I={student:"在校生",graduate:"毕业生",teacher:"老师",staff:"教职工"},S=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,y=async()=>{j.value=!0;try{const t=new URLSearchParams({page:w.value,limit:20,user_id:S()});C.value&&t.append("keyword",C.value);const k=await(await fetch(`/api/admin/users?${t}`)).json();k.success&&(x.value=k.data||[],U.value=k.total||x.value.length)}catch(t){console.error("加载用户失败:",t),i.error("加载用户失败")}finally{j.value=!1}},$=()=>{w.value=1,y()},O=t=>{w.value=t,y()},P=t=>{p.value={id:t.id,name:t.name,role:t.role||"user"},g.value=!0},z=async()=>{f.value=!0;try{const e=await(await fetch(`/api/admin/users/${p.value.id}/role`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:p.value.role,user_id:S()})})).json();e.success?(i.success("角色更新成功"),g.value=!1,y()):i.error(e.message||"更新失败")}catch(t){console.error("更新角色失败:",t),i.error("更新失败")}finally{f.value=!1}},E=t=>{s.value={id:t.id,name:t.name,currentRating:t.rating||0,adjustment:0,remark:""},b.value=!0},J=async()=>{if(s.value.adjustment===0){i.warning("请输入调整值");return}f.value=!0;try{const e=await(await fetch(`/api/admin/users/${s.value.id}/adjust-rating`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({adjustment:s.value.adjustment,remark:s.value.remark,user_id:S()})})).json();e.success?(i.success("积分调整成功"),b.value=!1,y()):i.error(e.message||"调整失败")}catch(t){console.error("调整积分失败:",t),i.error("调整失败")}finally{f.value=!1}};return Q(()=>{y()}),(t,e)=>{const k=n("Search"),K=n("el-icon"),m=n("el-button"),D=n("el-input"),r=n("el-table-column"),R=n("el-tag"),F=n("el-table"),L=n("el-pagination"),M=n("el-card"),v=n("el-form-item"),N=n("el-option"),q=n("el-select"),T=n("el-form"),B=n("el-dialog"),A=n("el-input-number"),G=X("loading");return _(),W("div",ae,[e[18]||(e[18]=c("div",{class:"page-header"},[c("h2",null,"用户管理")],-1)),l(M,null,{default:a(()=>[c("div",te,[l(D,{modelValue:C.value,"onUpdate:modelValue":e[0]||(e[0]=o=>C.value=o),placeholder:"搜索用户名/手机号",style:{width:"250px"},onKeyup:ee($,["enter"])},{append:a(()=>[l(m,{onClick:$},{default:a(()=>[l(K,null,{default:a(()=>[l(k)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),Y((_(),V(F,{data:x.value,stripe:""},{default:a(()=>[l(r,{prop:"id",label:"ID",width:"60"}),l(r,{prop:"name",label:"姓名",width:"100"}),l(r,{prop:"phone",label:"手机号",width:"130"}),l(r,{prop:"user_type",label:"身份",width:"80"},{default:a(({row:o})=>[d(h(I[o.user_type]||o.user_type),1)]),_:1}),l(r,{prop:"school_name",label:"学校",width:"150"}),l(r,{prop:"college_name",label:"学院",width:"120"}),l(r,{prop:"rating",label:"积分",width:"80"}),l(r,{prop:"role",label:"角色",width:"100"},{default:a(({row:o})=>[o.role==="super_admin"?(_(),V(R,{key:0,type:"danger"},{default:a(()=>[...e[8]||(e[8]=[d("超级管理",-1)])]),_:1})):o.role==="school_admin"?(_(),V(R,{key:1,type:"warning"},{default:a(()=>[...e[9]||(e[9]=[d("校管理员",-1)])]),_:1})):(_(),V(R,{key:2,type:"info"},{default:a(()=>[...e[10]||(e[10]=[d("普通用户",-1)])]),_:1}))]),_:1}),l(r,{prop:"created_at",label:"注册时间",width:"160"}),l(r,{label:"操作",width:"200",fixed:"right"},{default:a(({row:o})=>[l(m,{size:"small",onClick:H=>P(o)},{default:a(()=>[...e[11]||(e[11]=[d("设置角色",-1)])]),_:1},8,["onClick"]),l(m,{size:"small",onClick:H=>E(o)},{default:a(()=>[...e[12]||(e[12]=[d("调整积分",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[G,j.value]]),U.value>20?(_(),V(L,{key:0,class:"pagination","current-page":w.value,"page-size":20,total:U.value,layout:"prev, pager, next",onCurrentChange:O},null,8,["current-page","total"])):Z("",!0)]),_:1}),l(B,{modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=o=>g.value=o),title:"设置用户角色",width:"400px"},{footer:a(()=>[l(m,{onClick:e[2]||(e[2]=o=>g.value=!1)},{default:a(()=>[...e[13]||(e[13]=[d("取消",-1)])]),_:1}),l(m,{type:"primary",onClick:z,loading:f.value},{default:a(()=>[...e[14]||(e[14]=[d("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(T,{model:p.value,"label-width":"80px"},{default:a(()=>[l(v,{label:"用户"},{default:a(()=>[c("span",null,h(p.value.name),1)]),_:1}),l(v,{label:"角色"},{default:a(()=>[l(q,{modelValue:p.value.role,"onUpdate:modelValue":e[1]||(e[1]=o=>p.value.role=o)},{default:a(()=>[l(N,{label:"普通用户",value:"user"}),l(N,{label:"校管理员",value:"school_admin"}),l(N,{label:"超级管理员",value:"super_admin"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(B,{modelValue:b.value,"onUpdate:modelValue":e[7]||(e[7]=o=>b.value=o),title:"调整用户积分",width:"400px"},{footer:a(()=>[l(m,{onClick:e[6]||(e[6]=o=>b.value=!1)},{default:a(()=>[...e[16]||(e[16]=[d("取消",-1)])]),_:1}),l(m,{type:"primary",onClick:J,loading:f.value},{default:a(()=>[...e[17]||(e[17]=[d("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(T,{model:s.value,"label-width":"80px"},{default:a(()=>[l(v,{label:"用户"},{default:a(()=>[c("span",null,h(s.value.name),1)]),_:1}),l(v,{label:"当前积分"},{default:a(()=>[c("span",null,h(s.value.currentRating),1)]),_:1}),l(v,{label:"调整值"},{default:a(()=>[l(A,{modelValue:s.value.adjustment,"onUpdate:modelValue":e[4]||(e[4]=o=>s.value.adjustment=o),min:-1e3,max:1e3},null,8,["modelValue"]),e[15]||(e[15]=c("span",{style:{"margin-left":"10px",color:"#999"}},"正数增加，负数减少",-1))]),_:1}),l(v,{label:"备注"},{default:a(()=>[l(D,{modelValue:s.value.remark,"onUpdate:modelValue":e[5]||(e[5]=o=>s.value.remark=o),placeholder:"调整原因"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},ue=le(oe,[["__scopeId","data-v-b47b816e"]]);export{ue as default};
