import{r as u,p as H,c as E,o as p,b as f,d as a,w as t,f as o,E as m,q as Q,h as i,k as T,t as y,s as W,l as _,g as X,m as Y,G as Z}from"./index-CFDikFN1.js";import{f as ee}from"./format-DoeqoNZs.js";import{_ as ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";const te={class:"page"},le={class:"page-header"},ne={key:0},oe={class:"search-bar"},se={__name:"Users",setup(re){const x=u(!1),C=u([]),b=u(1),j=u(0),w=u(""),U=u(!1),S=u(!1),c=u(0),g=u(!1),s=u({id:null,name:"",currentRating:0,adjustment:0,remark:""}),$={student:"在校生",graduate:"毕业生",teacher:"老师",staff:"教职工"},h=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,v=async()=>{x.value=!0;try{const l=new URLSearchParams({page:b.value,limit:20,user_id:h()});w.value&&l.append("keyword",w.value);const d=await(await fetch(`/api/admin/users?${l}`)).json();d.success&&(C.value=d.data||[],j.value=d.total||C.value.length)}catch(l){console.error("加载用户失败:",l),m.error("加载用户失败")}finally{x.value=!1}},B=()=>{b.value=1,v()},N=l=>{b.value=l,v()},R=l=>{s.value={id:l.id,name:l.name,currentRating:l.rating||0,adjustment:0,remark:""},g.value=!0},I=async()=>{if(s.value.adjustment===0){m.warning("请输入调整值");return}U.value=!0;try{const e=await(await fetch(`/api/admin/users/${s.value.id}/adjust-rating`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({adjustment:s.value.adjustment,remark:s.value.remark,user_id:h()})})).json();e.success?(m.success("积分调整成功"),g.value=!1,v()):m.error(e.message||"调整失败")}catch(l){console.error("调整积分失败:",l),m.error("调整失败")}finally{U.value=!1}};H(()=>{v(),z()});const z=async()=>{try{const e=await(await fetch(`/api/admin/users/unregistered/count?user_id=${h()}`)).json();e.success&&(c.value=e.data.count)}catch(l){console.error("获取未注册用户数量失败:",l)}},K=async()=>{if(c.value===0){m.info("没有需要清理的未注册用户");return}try{await Z.confirm(`确定要清理 ${c.value} 个未注册用户吗？这些用户只有openid，没有填写任何资料。`,"清理确认",{confirmButtonText:"确定清理",cancelButtonText:"取消",type:"warning"})}catch{return}S.value=!0;try{const e=await(await fetch(`/api/admin/users/unregistered?user_id=${h()}`,{method:"DELETE"})).json();e.success?(m.success(e.message),c.value=0,v()):m.error(e.message||"清理失败")}catch(l){console.error("清理未注册用户失败:",l),m.error("清理失败")}finally{S.value=!1}};return(l,e)=>{const d=o("el-button"),L=o("Search"),M=o("el-icon"),D=o("el-input"),r=o("el-table-column"),k=o("el-tag"),O=o("el-table"),P=o("el-pagination"),J=o("el-card"),V=o("el-form-item"),q=o("el-input-number"),F=o("el-form"),G=o("el-dialog"),A=Q("loading");return p(),E("div",te,[f("div",le,[e[6]||(e[6]=f("h2",null,"用户管理",-1)),a(d,{type:"danger",size:"small",onClick:K,loading:S.value},{default:t(()=>[e[5]||(e[5]=i(" 清理未注册用户 ",-1)),c.value>0?(p(),E("span",ne,"("+y(c.value)+")",1)):T("",!0)]),_:1},8,["loading"])]),a(J,null,{default:t(()=>[f("div",oe,[a(D,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=n=>w.value=n),placeholder:"搜索用户名/手机号",style:{width:"250px"},onKeyup:X(B,["enter"])},{append:t(()=>[a(d,{onClick:B},{default:t(()=>[a(M,null,{default:t(()=>[a(L)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),W((p(),_(O,{data:C.value,stripe:""},{default:t(()=>[a(r,{prop:"id",label:"ID",width:"60"}),a(r,{prop:"name",label:"姓名","min-width":"100"}),a(r,{prop:"phone",label:"手机号","min-width":"130"}),a(r,{prop:"user_type",label:"身份",width:"80"},{default:t(({row:n})=>[i(y($[n.user_type]||n.user_type),1)]),_:1}),a(r,{prop:"school_name",label:"学校","min-width":"150"}),a(r,{prop:"college_name",label:"学院","min-width":"120"}),a(r,{prop:"rating",label:"积分",width:"80"}),a(r,{prop:"role",label:"角色",width:"100"},{default:t(({row:n})=>[n.role==="super_admin"?(p(),_(k,{key:0,type:"danger"},{default:t(()=>[...e[7]||(e[7]=[i("超级管理",-1)])]),_:1})):n.role==="school_admin"?(p(),_(k,{key:1,type:"warning"},{default:t(()=>[...e[8]||(e[8]=[i("校管理员",-1)])]),_:1})):n.role==="event_manager"?(p(),_(k,{key:2,type:"success"},{default:t(()=>[...e[9]||(e[9]=[i("赛事管理",-1)])]),_:1})):(p(),_(k,{key:3,type:"info"},{default:t(()=>[...e[10]||(e[10]=[i("普通用户",-1)])]),_:1}))]),_:1}),a(r,{label:"注册时间",width:"160"},{default:t(({row:n})=>[i(y(Y(ee)(n.created_at)),1)]),_:1}),a(r,{label:"操作",width:"100",fixed:"right"},{default:t(({row:n})=>[a(d,{size:"small",onClick:ue=>R(n)},{default:t(()=>[...e[11]||(e[11]=[i("调整积分",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[A,x.value]]),j.value>20?(p(),_(P,{key:0,class:"pagination","current-page":b.value,"page-size":20,total:j.value,layout:"prev, pager, next",onCurrentChange:N},null,8,["current-page","total"])):T("",!0)]),_:1}),a(G,{modelValue:g.value,"onUpdate:modelValue":e[4]||(e[4]=n=>g.value=n),title:"调整用户积分",width:"400px"},{footer:t(()=>[a(d,{onClick:e[3]||(e[3]=n=>g.value=!1)},{default:t(()=>[...e[13]||(e[13]=[i("取消",-1)])]),_:1}),a(d,{type:"primary",onClick:I,loading:U.value},{default:t(()=>[...e[14]||(e[14]=[i("确定",-1)])]),_:1},8,["loading"])]),default:t(()=>[a(F,{model:s.value,"label-width":"80px"},{default:t(()=>[a(V,{label:"用户"},{default:t(()=>[f("span",null,y(s.value.name),1)]),_:1}),a(V,{label:"当前积分"},{default:t(()=>[f("span",null,y(s.value.currentRating),1)]),_:1}),a(V,{label:"调整值"},{default:t(()=>[a(q,{modelValue:s.value.adjustment,"onUpdate:modelValue":e[1]||(e[1]=n=>s.value.adjustment=n),min:-1e4,max:1e4},null,8,["modelValue"]),e[12]||(e[12]=f("span",{style:{"margin-left":"10px",color:"#999"}},"正数增加，负数减少",-1))]),_:1}),a(V,{label:"备注"},{default:t(()=>[a(D,{modelValue:s.value.remark,"onUpdate:modelValue":e[2]||(e[2]=n=>s.value.remark=n),placeholder:"调整原因"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},pe=ae(se,[["__scopeId","data-v-aae5214e"]]);export{pe as default};
