import{r as i,p as L,c as M,o as d,b as m,d as a,w as t,f as o,E as f,q,s as F,l as p,k as A,g as G,h as u,t as h,m as H}from"./index-D4feKi_o.js";import{f as Q}from"./format-DoeqoNZs.js";import{_ as W}from"./_plugin-vue_export-helper-DlAUqK2U.js";const X={class:"page"},Y={class:"search-bar"},Z={__name:"Users",setup(ee){const V=i(!1),j=i([]),g=i(1),x=i(0),v=i(""),C=i(!1),c=i(!1),s=i({id:null,name:"",currentRating:0,adjustment:0,remark:""}),N={student:"在校生",graduate:"毕业生",teacher:"老师",staff:"教职工"},U=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,b=async()=>{V.value=!0;try{const n=new URLSearchParams({page:g.value,limit:20,user_id:U()});v.value&&n.append("keyword",v.value);const _=await(await fetch(`/api/admin/users?${n}`)).json();_.success&&(j.value=_.data||[],x.value=_.total||j.value.length)}catch(n){console.error("加载用户失败:",n),f.error("加载用户失败")}finally{V.value=!1}},S=()=>{g.value=1,b()},R=n=>{g.value=n,b()},B=n=>{s.value={id:n.id,name:n.name,currentRating:n.rating||0,adjustment:0,remark:""},c.value=!0},I=async()=>{if(s.value.adjustment===0){f.warning("请输入调整值");return}C.value=!0;try{const e=await(await fetch(`/api/admin/users/${s.value.id}/adjust-rating`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({adjustment:s.value.adjustment,remark:s.value.remark,user_id:U()})})).json();e.success?(f.success("积分调整成功"),c.value=!1,b()):f.error(e.message||"调整失败")}catch(n){console.error("调整积分失败:",n),f.error("调整失败")}finally{C.value=!1}};return L(()=>{b()}),(n,e)=>{const _=o("Search"),T=o("el-icon"),y=o("el-button"),D=o("el-input"),r=o("el-table-column"),k=o("el-tag"),$=o("el-table"),E=o("el-pagination"),K=o("el-card"),w=o("el-form-item"),O=o("el-input-number"),P=o("el-form"),z=o("el-dialog"),J=q("loading");return d(),M("div",X,[e[13]||(e[13]=m("div",{class:"page-header"},[m("h2",null,"用户管理")],-1)),a(K,null,{default:t(()=>[m("div",Y,[a(D,{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=l=>v.value=l),placeholder:"搜索用户名/手机号",style:{width:"250px"},onKeyup:G(S,["enter"])},{append:t(()=>[a(y,{onClick:S},{default:t(()=>[a(T,null,{default:t(()=>[a(_)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),F((d(),p($,{data:j.value,stripe:""},{default:t(()=>[a(r,{prop:"id",label:"ID",width:"60"}),a(r,{prop:"name",label:"姓名","min-width":"100"}),a(r,{prop:"phone",label:"手机号","min-width":"130"}),a(r,{prop:"user_type",label:"身份",width:"80"},{default:t(({row:l})=>[u(h(N[l.user_type]||l.user_type),1)]),_:1}),a(r,{prop:"school_name",label:"学校","min-width":"150"}),a(r,{prop:"college_name",label:"学院","min-width":"120"}),a(r,{prop:"rating",label:"积分",width:"80"}),a(r,{prop:"role",label:"角色",width:"100"},{default:t(({row:l})=>[l.role==="super_admin"?(d(),p(k,{key:0,type:"danger"},{default:t(()=>[...e[5]||(e[5]=[u("超级管理",-1)])]),_:1})):l.role==="school_admin"?(d(),p(k,{key:1,type:"warning"},{default:t(()=>[...e[6]||(e[6]=[u("校管理员",-1)])]),_:1})):l.role==="event_manager"?(d(),p(k,{key:2,type:"success"},{default:t(()=>[...e[7]||(e[7]=[u("赛事管理",-1)])]),_:1})):(d(),p(k,{key:3,type:"info"},{default:t(()=>[...e[8]||(e[8]=[u("普通用户",-1)])]),_:1}))]),_:1}),a(r,{label:"注册时间",width:"160"},{default:t(({row:l})=>[u(h(H(Q)(l.created_at)),1)]),_:1}),a(r,{label:"操作",width:"100",fixed:"right"},{default:t(({row:l})=>[a(y,{size:"small",onClick:ae=>B(l)},{default:t(()=>[...e[9]||(e[9]=[u("调整积分",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[J,V.value]]),x.value>20?(d(),p(E,{key:0,class:"pagination","current-page":g.value,"page-size":20,total:x.value,layout:"prev, pager, next",onCurrentChange:R},null,8,["current-page","total"])):A("",!0)]),_:1}),a(z,{modelValue:c.value,"onUpdate:modelValue":e[4]||(e[4]=l=>c.value=l),title:"调整用户积分",width:"400px"},{footer:t(()=>[a(y,{onClick:e[3]||(e[3]=l=>c.value=!1)},{default:t(()=>[...e[11]||(e[11]=[u("取消",-1)])]),_:1}),a(y,{type:"primary",onClick:I,loading:C.value},{default:t(()=>[...e[12]||(e[12]=[u("确定",-1)])]),_:1},8,["loading"])]),default:t(()=>[a(P,{model:s.value,"label-width":"80px"},{default:t(()=>[a(w,{label:"用户"},{default:t(()=>[m("span",null,h(s.value.name),1)]),_:1}),a(w,{label:"当前积分"},{default:t(()=>[m("span",null,h(s.value.currentRating),1)]),_:1}),a(w,{label:"调整值"},{default:t(()=>[a(O,{modelValue:s.value.adjustment,"onUpdate:modelValue":e[1]||(e[1]=l=>s.value.adjustment=l),min:-1e3,max:1e3},null,8,["modelValue"]),e[10]||(e[10]=m("span",{style:{"margin-left":"10px",color:"#999"}},"正数增加，负数减少",-1))]),_:1}),a(w,{label:"备注"},{default:t(()=>[a(D,{modelValue:s.value.remark,"onUpdate:modelValue":e[2]||(e[2]=l=>s.value.remark=l),placeholder:"调整原因"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},oe=W(Z,[["__scopeId","data-v-cb75067b"]]);export{oe as default};
