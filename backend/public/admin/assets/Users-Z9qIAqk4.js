import{r as u,p as q,c as F,o as d,b as m,d as a,w as t,f as o,E as f,q as A,s as G,l as p,k as H,g as Q,h as i,t as h,m as W}from"./index-Vrp0Tbun.js";import{f as X}from"./format-DoeqoNZs.js";import{_ as Y}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Z={class:"page"},ee={class:"search-bar"},ae={__name:"Users",setup(te){const V=u(!1),C=u([]),g=u(1),j=u(0),v=u(""),x=u(!1);u(!1);const N=u(0),c=u(!1),s=u({id:null,name:"",currentRating:0,adjustment:0,remark:""}),R={student:"在校生",graduate:"毕业生",teacher:"老师",staff:"教职工"},U=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,y=async()=>{V.value=!0;try{const n=new URLSearchParams({page:g.value,limit:20,user_id:U()});v.value&&n.append("keyword",v.value);const _=await(await fetch(`/api/admin/users?${n}`)).json();_.success&&(C.value=_.data||[],j.value=_.total||C.value.length)}catch(n){console.error("加载用户失败:",n),f.error("加载用户失败")}finally{V.value=!1}},S=()=>{g.value=1,y()},$=n=>{g.value=n,y()},B=n=>{s.value={id:n.id,name:n.name,currentRating:n.rating||0,adjustment:0,remark:""},c.value=!0},I=async()=>{if(s.value.adjustment===0){f.warning("请输入调整值");return}x.value=!0;try{const e=await(await fetch(`/api/admin/users/${s.value.id}/adjust-rating`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({adjustment:s.value.adjustment,remark:s.value.remark,user_id:U()})})).json();e.success?(f.success("积分调整成功"),c.value=!1,y()):f.error(e.message||"调整失败")}catch(n){console.error("调整积分失败:",n),f.error("调整失败")}finally{x.value=!1}};q(()=>{y(),T()});const T=async()=>{try{const e=await(await fetch(`/api/admin/users/unregistered/count?user_id=${U()}`)).json();e.success&&(N.value=e.data.count)}catch(n){console.error("获取未注册用户数量失败:",n)}};return(n,e)=>{const _=o("Search"),E=o("el-icon"),b=o("el-button"),D=o("el-input"),r=o("el-table-column"),w=o("el-tag"),K=o("el-table"),O=o("el-pagination"),P=o("el-card"),k=o("el-form-item"),z=o("el-input-number"),J=o("el-form"),L=o("el-dialog"),M=A("loading");return d(),F("div",Z,[e[13]||(e[13]=m("div",{class:"page-header"},[m("h2",null,"用户管理")],-1)),a(P,null,{default:t(()=>[m("div",ee,[a(D,{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=l=>v.value=l),placeholder:"搜索用户名/手机号",style:{width:"250px"},onKeyup:Q(S,["enter"])},{append:t(()=>[a(b,{onClick:S},{default:t(()=>[a(E,null,{default:t(()=>[a(_)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),G((d(),p(K,{data:C.value,stripe:""},{default:t(()=>[a(r,{prop:"id",label:"ID",width:"60"}),a(r,{prop:"name",label:"姓名","min-width":"100"}),a(r,{prop:"phone",label:"手机号","min-width":"130"}),a(r,{prop:"user_type",label:"身份",width:"80"},{default:t(({row:l})=>[i(h(R[l.user_type]||l.user_type),1)]),_:1}),a(r,{prop:"school_name",label:"学校","min-width":"150"}),a(r,{prop:"college_name",label:"学院","min-width":"120"}),a(r,{prop:"rating",label:"积分",width:"80"}),a(r,{prop:"role",label:"角色",width:"100"},{default:t(({row:l})=>[l.role==="super_admin"?(d(),p(w,{key:0,type:"danger"},{default:t(()=>[...e[5]||(e[5]=[i("超级管理",-1)])]),_:1})):l.role==="school_admin"?(d(),p(w,{key:1,type:"warning"},{default:t(()=>[...e[6]||(e[6]=[i("校管理员",-1)])]),_:1})):l.role==="event_manager"?(d(),p(w,{key:2,type:"success"},{default:t(()=>[...e[7]||(e[7]=[i("赛事管理",-1)])]),_:1})):(d(),p(w,{key:3,type:"info"},{default:t(()=>[...e[8]||(e[8]=[i("普通用户",-1)])]),_:1}))]),_:1}),a(r,{label:"注册时间",width:"160"},{default:t(({row:l})=>[i(h(W(X)(l.created_at)),1)]),_:1}),a(r,{label:"操作",width:"100",fixed:"right"},{default:t(({row:l})=>[a(b,{size:"small",onClick:le=>B(l)},{default:t(()=>[...e[9]||(e[9]=[i("调整积分",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[M,V.value]]),j.value>20?(d(),p(O,{key:0,class:"pagination","current-page":g.value,"page-size":20,total:j.value,layout:"prev, pager, next",onCurrentChange:$},null,8,["current-page","total"])):H("",!0)]),_:1}),a(L,{modelValue:c.value,"onUpdate:modelValue":e[4]||(e[4]=l=>c.value=l),title:"调整用户积分",width:"400px"},{footer:t(()=>[a(b,{onClick:e[3]||(e[3]=l=>c.value=!1)},{default:t(()=>[...e[11]||(e[11]=[i("取消",-1)])]),_:1}),a(b,{type:"primary",onClick:I,loading:x.value},{default:t(()=>[...e[12]||(e[12]=[i("确定",-1)])]),_:1},8,["loading"])]),default:t(()=>[a(J,{model:s.value,"label-width":"80px"},{default:t(()=>[a(k,{label:"用户"},{default:t(()=>[m("span",null,h(s.value.name),1)]),_:1}),a(k,{label:"当前积分"},{default:t(()=>[m("span",null,h(s.value.currentRating),1)]),_:1}),a(k,{label:"调整值"},{default:t(()=>[a(z,{modelValue:s.value.adjustment,"onUpdate:modelValue":e[1]||(e[1]=l=>s.value.adjustment=l),min:-1e4,max:1e4},null,8,["modelValue"]),e[10]||(e[10]=m("span",{style:{"margin-left":"10px",color:"#999"}},"正数增加，负数减少",-1))]),_:1}),a(k,{label:"备注"},{default:t(()=>[a(D,{modelValue:s.value.remark,"onUpdate:modelValue":e[2]||(e[2]=l=>s.value.remark=l),placeholder:"调整原因"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},re=Y(ae,[["__scopeId","data-v-fee81196"]]);export{re as default};
