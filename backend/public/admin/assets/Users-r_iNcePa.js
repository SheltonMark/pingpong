import{r as u,p as L,c as M,o as i,b as p,d as a,w as t,f as o,E as f,q,s as F,l as m,k as A,g as G,h as d,t as C}from"./index-BhydzvWF.js";import{_ as H}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Q={class:"page"},W={class:"search-bar"},X={__name:"Users",setup(Y){const h=u(!1),V=u([]),g=u(1),j=u(0),v=u(""),x=u(!1),c=u(!1),s=u({id:null,name:"",currentRating:0,adjustment:0,remark:""}),R={student:"在校生",graduate:"毕业生",teacher:"老师",staff:"教职工"},U=()=>JSON.parse(localStorage.getItem("adminUser")||"{}").id,y=async()=>{h.value=!0;try{const n=new URLSearchParams({page:g.value,limit:20,user_id:U()});v.value&&n.append("keyword",v.value);const _=await(await fetch(`/api/admin/users?${n}`)).json();_.success&&(V.value=_.data||[],j.value=_.total||V.value.length)}catch(n){console.error("加载用户失败:",n),f.error("加载用户失败")}finally{h.value=!1}},S=()=>{g.value=1,y()},D=n=>{g.value=n,y()},B=n=>{s.value={id:n.id,name:n.name,currentRating:n.rating||0,adjustment:0,remark:""},c.value=!0},I=async()=>{if(s.value.adjustment===0){f.warning("请输入调整值");return}x.value=!0;try{const e=await(await fetch(`/api/admin/users/${s.value.id}/adjust-rating`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({adjustment:s.value.adjustment,remark:s.value.remark,user_id:U()})})).json();e.success?(f.success("积分调整成功"),c.value=!1,y()):f.error(e.message||"调整失败")}catch(n){console.error("调整积分失败:",n),f.error("调整失败")}finally{x.value=!1}};return L(()=>{y()}),(n,e)=>{const _=o("Search"),$=o("el-icon"),b=o("el-button"),N=o("el-input"),r=o("el-table-column"),k=o("el-tag"),E=o("el-table"),K=o("el-pagination"),O=o("el-card"),w=o("el-form-item"),P=o("el-input-number"),T=o("el-form"),z=o("el-dialog"),J=q("loading");return i(),M("div",Q,[e[13]||(e[13]=p("div",{class:"page-header"},[p("h2",null,"用户管理")],-1)),a(O,null,{default:t(()=>[p("div",W,[a(N,{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=l=>v.value=l),placeholder:"搜索用户名/手机号",style:{width:"250px"},onKeyup:G(S,["enter"])},{append:t(()=>[a(b,{onClick:S},{default:t(()=>[a($,null,{default:t(()=>[a(_)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),F((i(),m(E,{data:V.value,stripe:""},{default:t(()=>[a(r,{prop:"id",label:"ID",width:"60"}),a(r,{prop:"name",label:"姓名",width:"100"}),a(r,{prop:"phone",label:"手机号",width:"130"}),a(r,{prop:"user_type",label:"身份",width:"80"},{default:t(({row:l})=>[d(C(R[l.user_type]||l.user_type),1)]),_:1}),a(r,{prop:"school_name",label:"学校",width:"150"}),a(r,{prop:"college_name",label:"学院",width:"120"}),a(r,{prop:"rating",label:"积分",width:"80"}),a(r,{prop:"role",label:"角色",width:"100"},{default:t(({row:l})=>[l.role==="super_admin"?(i(),m(k,{key:0,type:"danger"},{default:t(()=>[...e[5]||(e[5]=[d("超级管理",-1)])]),_:1})):l.role==="school_admin"?(i(),m(k,{key:1,type:"warning"},{default:t(()=>[...e[6]||(e[6]=[d("校管理员",-1)])]),_:1})):l.role==="event_manager"?(i(),m(k,{key:2,type:"success"},{default:t(()=>[...e[7]||(e[7]=[d("赛事管理",-1)])]),_:1})):(i(),m(k,{key:3,type:"info"},{default:t(()=>[...e[8]||(e[8]=[d("普通用户",-1)])]),_:1}))]),_:1}),a(r,{prop:"created_at",label:"注册时间",width:"160"}),a(r,{label:"操作",width:"120",fixed:"right"},{default:t(({row:l})=>[a(b,{size:"small",onClick:Z=>B(l)},{default:t(()=>[...e[9]||(e[9]=[d("调整积分",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[J,h.value]]),j.value>20?(i(),m(K,{key:0,class:"pagination","current-page":g.value,"page-size":20,total:j.value,layout:"prev, pager, next",onCurrentChange:D},null,8,["current-page","total"])):A("",!0)]),_:1}),a(z,{modelValue:c.value,"onUpdate:modelValue":e[4]||(e[4]=l=>c.value=l),title:"调整用户积分",width:"400px"},{footer:t(()=>[a(b,{onClick:e[3]||(e[3]=l=>c.value=!1)},{default:t(()=>[...e[11]||(e[11]=[d("取消",-1)])]),_:1}),a(b,{type:"primary",onClick:I,loading:x.value},{default:t(()=>[...e[12]||(e[12]=[d("确定",-1)])]),_:1},8,["loading"])]),default:t(()=>[a(T,{model:s.value,"label-width":"80px"},{default:t(()=>[a(w,{label:"用户"},{default:t(()=>[p("span",null,C(s.value.name),1)]),_:1}),a(w,{label:"当前积分"},{default:t(()=>[p("span",null,C(s.value.currentRating),1)]),_:1}),a(w,{label:"调整值"},{default:t(()=>[a(P,{modelValue:s.value.adjustment,"onUpdate:modelValue":e[1]||(e[1]=l=>s.value.adjustment=l),min:-1e3,max:1e3},null,8,["modelValue"]),e[10]||(e[10]=p("span",{style:{"margin-left":"10px",color:"#999"}},"正数增加，负数减少",-1))]),_:1}),a(w,{label:"备注"},{default:t(()=>[a(N,{modelValue:s.value.remark,"onUpdate:modelValue":e[2]||(e[2]=l=>s.value.remark=l),placeholder:"调整原因"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},te=H(X,[["__scopeId","data-v-71a70900"]]);export{te as default};
