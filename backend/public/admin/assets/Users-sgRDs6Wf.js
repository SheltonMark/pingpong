import{r as u,n as W,c as X,o as c,b as v,d as l,w as a,f as n,E as i,p as Y,q as Z,l as k,k as ee,g as le,h as d,t as x}from"./index-Cf1Abx-S.js";import{a as R}from"./index-B9ygI19o.js";import{_ as ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";const te={class:"page"},oe={class:"search-bar"},D="https://express-lksv-207842-4-1391867763.sh.run.tcloudbase.com",ne={__name:"Users",setup(se){const C=u(!1),U=u([]),V=u(1),j=u(0),w=u(""),f=u(!1),g=u(!1),b=u(!1),p=u({id:null,name:"",role:""}),s=u({id:null,name:"",currentRating:0,adjustment:0,remark:""}),z={student:"在校生",graduate:"毕业生",teacher:"老师",staff:"教职工"},y=async()=>{C.value=!0;try{const t={page:V.value,limit:20};w.value&&(t.keyword=w.value);const e=await R.get(`${D}/api/admin/users`,{params:t});e.data.success&&(U.value=e.data.data.list||e.data.data,j.value=e.data.data.total||U.value.length)}catch(t){console.error("加载用户失败:",t),i.error("加载用户失败")}finally{C.value=!1}},B=()=>{V.value=1,y()},I=t=>{V.value=t,y()},K=t=>{p.value={id:t.id,name:t.name,role:t.role||"user"},g.value=!0},A=async()=>{f.value=!0;try{const t=await R.put(`${D}/api/admin/users/${p.value.id}/role`,{role:p.value.role});t.data.success?(i.success("角色更新成功"),g.value=!1,y()):i.error(t.data.message||"更新失败")}catch(t){console.error("更新角色失败:",t),i.error("更新失败")}finally{f.value=!1}},F=t=>{s.value={id:t.id,name:t.name,currentRating:t.rating||0,adjustment:0,remark:""},b.value=!0},M=async()=>{if(s.value.adjustment===0){i.warning("请输入调整值");return}f.value=!0;try{const t=await R.post(`${D}/api/admin/users/${s.value.id}/adjust-rating`,{adjustment:s.value.adjustment,remark:s.value.remark});t.data.success?(i.success("积分调整成功"),b.value=!1,y()):i.error(t.data.message||"调整失败")}catch(t){console.error("调整积分失败:",t),i.error("调整失败")}finally{f.value=!1}};return W(()=>{y()}),(t,e)=>{const P=n("Search"),q=n("el-icon"),m=n("el-button"),E=n("el-input"),r=n("el-table-column"),$=n("el-tag"),L=n("el-table"),T=n("el-pagination"),G=n("el-card"),_=n("el-form-item"),h=n("el-option"),H=n("el-select"),N=n("el-form"),S=n("el-dialog"),J=n("el-input-number"),O=Y("loading");return c(),X("div",te,[e[18]||(e[18]=v("div",{class:"page-header"},[v("h2",null,"用户管理")],-1)),l(G,null,{default:a(()=>[v("div",oe,[l(E,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=o=>w.value=o),placeholder:"搜索用户名/手机号",style:{width:"250px"},onKeyup:le(B,["enter"])},{append:a(()=>[l(m,{onClick:B},{default:a(()=>[l(q,null,{default:a(()=>[l(P)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),Z((c(),k(L,{data:U.value,stripe:""},{default:a(()=>[l(r,{prop:"id",label:"ID",width:"60"}),l(r,{prop:"name",label:"姓名",width:"100"}),l(r,{prop:"phone",label:"手机号",width:"130"}),l(r,{prop:"user_type",label:"身份",width:"80"},{default:a(({row:o})=>[d(x(z[o.user_type]||o.user_type),1)]),_:1}),l(r,{prop:"school_name",label:"学校",width:"150"}),l(r,{prop:"college_name",label:"学院",width:"120"}),l(r,{prop:"rating",label:"积分",width:"80"}),l(r,{prop:"role",label:"角色",width:"100"},{default:a(({row:o})=>[o.role==="super_admin"?(c(),k($,{key:0,type:"danger"},{default:a(()=>[...e[8]||(e[8]=[d("超级管理",-1)])]),_:1})):o.role==="school_admin"?(c(),k($,{key:1,type:"warning"},{default:a(()=>[...e[9]||(e[9]=[d("校管理员",-1)])]),_:1})):(c(),k($,{key:2,type:"info"},{default:a(()=>[...e[10]||(e[10]=[d("普通用户",-1)])]),_:1}))]),_:1}),l(r,{prop:"created_at",label:"注册时间",width:"160"}),l(r,{label:"操作",width:"200",fixed:"right"},{default:a(({row:o})=>[l(m,{size:"small",onClick:Q=>K(o)},{default:a(()=>[...e[11]||(e[11]=[d("设置角色",-1)])]),_:1},8,["onClick"]),l(m,{size:"small",onClick:Q=>F(o)},{default:a(()=>[...e[12]||(e[12]=[d("调整积分",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[O,C.value]]),j.value>20?(c(),k(T,{key:0,class:"pagination","current-page":V.value,"page-size":20,total:j.value,layout:"prev, pager, next",onCurrentChange:I},null,8,["current-page","total"])):ee("",!0)]),_:1}),l(S,{modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=o=>g.value=o),title:"设置用户角色",width:"400px"},{footer:a(()=>[l(m,{onClick:e[2]||(e[2]=o=>g.value=!1)},{default:a(()=>[...e[13]||(e[13]=[d("取消",-1)])]),_:1}),l(m,{type:"primary",onClick:A,loading:f.value},{default:a(()=>[...e[14]||(e[14]=[d("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(N,{model:p.value,"label-width":"80px"},{default:a(()=>[l(_,{label:"用户"},{default:a(()=>[v("span",null,x(p.value.name),1)]),_:1}),l(_,{label:"角色"},{default:a(()=>[l(H,{modelValue:p.value.role,"onUpdate:modelValue":e[1]||(e[1]=o=>p.value.role=o)},{default:a(()=>[l(h,{label:"普通用户",value:"user"}),l(h,{label:"校管理员",value:"school_admin"}),l(h,{label:"超级管理员",value:"super_admin"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(S,{modelValue:b.value,"onUpdate:modelValue":e[7]||(e[7]=o=>b.value=o),title:"调整用户积分",width:"400px"},{footer:a(()=>[l(m,{onClick:e[6]||(e[6]=o=>b.value=!1)},{default:a(()=>[...e[16]||(e[16]=[d("取消",-1)])]),_:1}),l(m,{type:"primary",onClick:M,loading:f.value},{default:a(()=>[...e[17]||(e[17]=[d("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(N,{model:s.value,"label-width":"80px"},{default:a(()=>[l(_,{label:"用户"},{default:a(()=>[v("span",null,x(s.value.name),1)]),_:1}),l(_,{label:"当前积分"},{default:a(()=>[v("span",null,x(s.value.currentRating),1)]),_:1}),l(_,{label:"调整值"},{default:a(()=>[l(J,{modelValue:s.value.adjustment,"onUpdate:modelValue":e[4]||(e[4]=o=>s.value.adjustment=o),min:-1e3,max:1e3},null,8,["modelValue"]),e[15]||(e[15]=v("span",{style:{"margin-left":"10px",color:"#999"}},"正数增加，负数减少",-1))]),_:1}),l(_,{label:"备注"},{default:a(()=>[l(E,{modelValue:s.value.remark,"onUpdate:modelValue":e[5]||(e[5]=o=>s.value.remark=o),placeholder:"调整原因"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},ie=ae(ne,[["__scopeId","data-v-bf7bf608"]]);export{ie as default};
