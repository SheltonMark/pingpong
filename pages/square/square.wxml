<view class="square-page">
  <!-- 审核模式：显示乒乓球规则 -->
  <view class="review-content" wx:if="{{reviewMode}}">
    <view class="rule-header">
      <text class="rule-title">🏓 乒乓球规则简介</text>
    </view>

    <view class="rule-card">
      <text class="rule-subtitle">基本规则</text>
      <text class="rule-text">1. 比赛采用11分制，先得11分者获胜</text>
      <text class="rule-text">2. 10平后需连续得2分才能获胜</text>
      <text class="rule-text">3. 每局比赛每方各发2球后交换发球权</text>
      <text class="rule-text">4. 决胜局中任何一方先得5分时交换场地</text>
    </view>

    <view class="rule-card">
      <text class="rule-subtitle">发球规则</text>
      <text class="rule-text">1. 发球时球需放在非执拍手的手掌上</text>
      <text class="rule-text">2. 发球时需将球垂直向上抛起至少16厘米</text>
      <text class="rule-text">3. 球下降时才能击球，且需先触及本方台面</text>
      <text class="rule-text">4. 发球时球和球拍需在台面水平面之上</text>
    </view>

    <view class="rule-card">
      <text class="rule-subtitle">比赛礼仪</text>
      <text class="rule-text">1. 比赛前后双方应握手致意</text>
      <text class="rule-text">2. 对方失误得分时不宜过度庆祝</text>
      <text class="rule-text">3. 擦网、擦边球得分应向对方示意</text>
      <text class="rule-text">4. 尊重裁判判罚，保持良好体育精神</text>
    </view>

    <view class="rule-card">
      <text class="rule-subtitle">常见术语</text>
      <text class="rule-text">• 正手：执拍手同侧的击球方式</text>
      <text class="rule-text">• 反手：执拍手异侧的击球方式</text>
      <text class="rule-text">• 弧圈球：带有强烈上旋的进攻球</text>
      <text class="rule-text">• 削球：带有下旋的防守球</text>
    </view>
  </view>

  <!-- 正常模式 -->
  <block wx:else>
  <!-- 顶部标题栏 -->
  <view class="square-header">
    <view class="header-top">
      <text class="page-title">广场</text>
      <view class="add-btn" bindtap="onTapPublish">+</view>
    </view>
    <!-- 筛选行 -->
    <view class="filter-row">
      <!-- 学校下拉选择器 -->
      <picker mode="selector" range="{{schoolPickerList}}" value="{{schoolPickerIndex}}" bindchange="onSchoolPickerChange">
        <view class="school-selector">
          <text class="selector-text">{{currentSchoolName || '全部学校'}}</text>
          <text class="selector-arrow">▼</text>
        </view>
      </picker>
      <!-- 类型标签 -->
      <view class="type-tabs">
        <view
          class="type-tab {{currentPostType === '' ? 'active' : ''}}"
          bindtap="onSelectType"
          data-type=""
        >全部</view>
        <view
          class="type-tab {{currentPostType === 'post' ? 'active' : ''}}"
          bindtap="onSelectType"
          data-type="post"
        >帖子</view>
        <view
          class="type-tab {{currentPostType === 'invitation' ? 'active' : ''}}"
          bindtap="onSelectType"
          data-type="invitation"
        >约球</view>
      </view>
    </view>
  </view>

  <!-- 帖子列表 -->
  <scroll-view
    class="post-list"
    scroll-y
    scroll-top="{{scrollTop}}"
    scroll-with-animation="{{true}}"
    enhanced="{{true}}"
    bounces="{{true}}"
    show-scrollbar="{{true}}"
    bindscrolltolower="onLoadMore"
    refresher-enabled
    bindrefresherrefresh="onRefresh"
    refresher-triggered="{{isRefreshing}}"
  >
    <view class="post-item" wx:for="{{posts}}" wx:key="id" bindtap="onTapPost" data-id="{{item.id}}">
      <view class="post-header">
        <image class="author-avatar" src="{{item.author_avatar || '/images/default-avatar.png'}}" mode="aspectFill" catchtap="{{item.author_id ? 'onTapUserAvatar' : ''}}" data-id="{{item.author_id}}" />
        <view class="author-info">
          <text class="author-name">{{item.author_name}}</text>
          <text class="post-meta">{{item.time_label}} · {{item.college_name || item.school_name || ''}}</text>
        </view>
      </view>

      <text class="post-content">{{item.content}}</text>

      <!-- 约球卡片（如果有关联的约球） -->
      <view class="match-box" wx:if="{{item.invitation}}" catchtap="onTapInvitation" data-id="{{item.invitation.id}}">
        <view class="match-title">🏓 发起约球</view>
        <view class="match-detail">
          <text wx:if="{{item.invitation.location}}">📍 {{item.invitation.location}}</text>
          <text wx:if="{{item.invitation.scheduled_time}}"> · 🕐 {{item.invitation.time_label}}</text>
        </view>
        <button class="match-join" catchtap="onJoinInvitation" data-id="{{item.invitation.id}}">我要参加</button>
      </view>

      <!-- 图片网格 -->
      <view class="post-images {{item.images.length === 1 ? 'single' : (item.images.length <= 4 ? 'grid-2' : 'grid-3')}}" wx:if="{{item.images && item.images.length > 0}}">
        <image
          wx:for="{{item.images}}"
          wx:for-item="img"
          wx:key="*this"
          class="post-image"
          src="{{img}}"
          mode="aspectFill"
          catchtap="onPreviewImage"
          data-urls="{{item.images}}"
          data-current="{{img}}"
        />
      </view>

      <view class="post-actions">
        <view class="action-item {{item.is_liked ? 'liked' : ''}}" catchtap="onTapLike" data-id="{{item.id}}" data-index="{{index}}">
          <text class="icon-heart">{{item.is_liked ? '❤️' : '🤍'}}</text>
          <text class="action-count">{{item.like_count || 0}}</text>
        </view>
        <view class="action-item">
          <text class="icon-comment">💬</text>
          <text class="action-count">{{item.comment_count || 0}}</text>
        </view>
      </view>
    </view>

    <!-- 约球卡片列表（如果没有帖子关联的约球，单独显示） -->
    <block wx:for="{{standaloneInvitations}}" wx:key="id">
      <view class="post-item invitation-card" bindtap="onTapInvitation" data-id="{{item.id}}">
        <view class="post-header">
          <image class="author-avatar" src="{{item.creator_avatar || '/images/default-avatar.png'}}" mode="aspectFill" catchtap="{{item.creator_id ? 'onTapUserAvatar' : ''}}" data-id="{{item.creator_id}}" />
          <view class="author-info">
            <text class="author-name">{{item.creator_name}}</text>
            <text class="post-meta">{{item.time_label}} · {{item.school_name || ''}}</text>
          </view>
        </view>

        <view class="match-box standalone">
          <view class="match-title">🏓 {{item.title || '约球'}}</view>
          <view class="match-detail">
            <text wx:if="{{item.location}}">📍 {{item.location}}</text>
            <text wx:if="{{item.scheduled_time}}"> · 🕐 {{item.scheduled_time_label}}</text>
          </view>
          <view class="match-progress">
            <text class="progress-text">{{item.participant_count || 1}}/{{item.max_participants}}人参与</text>
          </view>
          <button class="match-join" wx:if="{{item.status === 'open'}}" catchtap="onJoinInvitation" data-id="{{item.id}}">我要参加</button>
          <view class="match-status" wx:else>{{item.status === 'full' ? '已满员' : (item.status === 'ongoing' ? '进行中' : '已结束')}}</view>
        </view>
      </view>
    </block>

    <view class="load-more" wx:if="{{isLoading}}">
      <text>加载中...</text>
    </view>
    <view class="no-more" wx:if="{{noMore && posts.length > 0}}">
      <text>没有更多了</text>
    </view>
    <view class="empty" wx:if="{{!isLoading && posts.length === 0 && standaloneInvitations.length === 0}}">
      <text class="empty-icon">📝</text>
      <text class="empty-text">还没有动态，快来发第一条吧</text>
    </view>
  </scroll-view>
  </block>
</view>
