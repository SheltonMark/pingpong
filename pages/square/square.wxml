<view class="square-page">
  <!-- é¡¶éƒ¨ç­›é€‰æ  -->
  <view class="filter-bar">
    <view class="school-filter" bindtap="onTapSchoolFilter">
      <text class="filter-text">{{currentSchoolName || 'å…¨éƒ¨å­¦æ ¡'}}</text>
      <text class="filter-arrow">â–¼</text>
    </view>
    <view class="tab-bar">
      <view
        class="tab-item {{currentTab === 'posts' ? 'active' : ''}}"
        bindtap="onSwitchTab"
        data-tab="posts"
      >åŠ¨æ€</view>
      <view
        class="tab-item {{currentTab === 'invitations' ? 'active' : ''}}"
        bindtap="onSwitchTab"
        data-tab="invitations"
      >çº¦çƒ</view>
    </view>
  </view>

  <!-- å¸–å­åˆ—è¡¨ -->
  <scroll-view
    wx:if="{{currentTab === 'posts'}}"
    class="post-list"
    scroll-y
    bindscrolltolower="onLoadMore"
    refresher-enabled
    bindrefresherrefresh="onRefresh"
    refresher-triggered="{{isRefreshing}}"
  >
    <view class="post-item" wx:for="{{posts}}" wx:key="id" bindtap="onTapPost" data-id="{{item.id}}">
      <view class="post-header">
        <image class="author-avatar" src="{{item.author_avatar || '/images/default-avatar.png'}}" mode="aspectFill" />
        <view class="author-info">
          <text class="author-name">{{item.author_name}}</text>
          <text class="post-time">{{item.time_label}}</text>
        </view>
      </view>

      <text class="post-content">{{item.content}}</text>

      <view class="post-images {{item.images.length === 1 ? 'single' : (item.images.length <= 4 ? 'grid-2' : 'grid-3')}}" wx:if="{{item.images.length > 0}}">
        <image
          wx:for="{{item.images}}"
          wx:for-item="img"
          wx:key="*this"
          class="post-image"
          src="{{img}}"
          mode="aspectFill"
          catchtap="onPreviewImage"
          data-urls="{{item.images}}"
          data-current="{{img}}"
        />
      </view>

      <view class="post-actions">
        <view class="action-item" catchtap="onTapLike" data-id="{{item.id}}" data-index="{{index}}">
          <text class="action-icon {{item.is_liked ? 'liked' : ''}}">{{item.is_liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
          <text class="action-count">{{item.like_count || 0}}</text>
        </view>
        <view class="action-item">
          <text class="action-icon">ğŸ’¬</text>
          <text class="action-count">{{item.comment_count || 0}}</text>
        </view>
      </view>
    </view>

    <view class="load-more" wx:if="{{isLoading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
    <view class="no-more" wx:if="{{noMore && posts.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
    <view class="empty" wx:if="{{!isLoading && posts.length === 0}}">
      <text class="empty-icon">ğŸ“</text>
      <text class="empty-text">è¿˜æ²¡æœ‰åŠ¨æ€ï¼Œå¿«æ¥å‘ç¬¬ä¸€æ¡å§</text>
    </view>
  </scroll-view>

  <!-- çº¦çƒåˆ—è¡¨ -->
  <scroll-view
    wx:if="{{currentTab === 'invitations'}}"
    class="invitation-list"
    scroll-y
    bindscrolltolower="onLoadMoreInvitations"
    refresher-enabled
    bindrefresherrefresh="onRefreshInvitations"
    refresher-triggered="{{isRefreshingInvitations}}"
  >
    <view class="invitation-item" wx:for="{{invitations}}" wx:key="id" bindtap="onTapInvitation" data-id="{{item.id}}">
      <view class="invitation-header">
        <image class="creator-avatar" src="{{item.creator_avatar || '/images/default-avatar.png'}}" mode="aspectFill" />
        <view class="creator-info">
          <text class="creator-name">{{item.creator_name}}</text>
          <text class="invitation-school">{{item.school_name}}</text>
        </view>
        <view class="invitation-status status-{{item.status}}">
          {{item.status === 'open' ? 'æ‹›å‹Ÿä¸­' : (item.status === 'full' ? 'å·²æ»¡å‘˜' : (item.status === 'ongoing' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'))}}
        </view>
      </view>

      <view class="invitation-body">
        <text class="invitation-title">{{item.title || 'çº¦çƒ'}}</text>
        <view class="invitation-meta">
          <text wx:if="{{item.location}}">ğŸ“ {{item.location}}</text>
          <text wx:if="{{item.scheduled_time}}">ğŸ• {{item.time_label}}</text>
        </view>
        <view class="invitation-progress">
          <text class="progress-text">{{item.participant_count}}/{{item.max_participants}}äºº</text>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{item.participant_count / item.max_participants * 100}}%"></view>
          </view>
        </view>
      </view>
    </view>

    <view class="empty" wx:if="{{!isLoadingInvitations && invitations.length === 0}}">
      <text class="empty-icon">ğŸ“</text>
      <text class="empty-text">è¿˜æ²¡æœ‰çº¦çƒï¼Œå¿«æ¥å‘èµ·ä¸€åœºå§</text>
    </view>
  </scroll-view>

  <!-- å‘å¸ƒæŒ‰é’® -->
  <view class="fab-button" bindtap="onTapPublish">
    <text class="fab-icon">+</text>
  </view>
</view>
