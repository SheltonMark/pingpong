<view class="square-page">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <view class="square-header">
    <view class="header-top">
      <text class="page-title">å¹¿åœº</text>
      <view class="add-btn" bindtap="onTapPublish">+</view>
    </view>
    <!-- ç­›é€‰è¡Œ -->
    <view class="filter-row">
      <!-- å­¦æ ¡ä¸‹æ‹‰é€‰æ‹©å™¨ -->
      <picker mode="selector" range="{{schoolPickerList}}" value="{{schoolPickerIndex}}" bindchange="onSchoolPickerChange">
        <view class="school-selector">
          <text class="selector-text">{{currentSchoolName || 'å…¨éƒ¨å­¦æ ¡'}}</text>
          <text class="selector-arrow">â–¼</text>
        </view>
      </picker>
      <!-- ç±»å‹æ ‡ç­¾ -->
      <view class="type-tabs">
        <view
          class="type-tab {{currentPostType === '' ? 'active' : ''}}"
          bindtap="onSelectType"
          data-type=""
        >å…¨éƒ¨</view>
        <view
          class="type-tab {{currentPostType === 'post' ? 'active' : ''}}"
          bindtap="onSelectType"
          data-type="post"
        >å¸–å­</view>
        <view
          class="type-tab {{currentPostType === 'invitation' ? 'active' : ''}}"
          bindtap="onSelectType"
          data-type="invitation"
        >çº¦çƒ</view>
      </view>
    </view>
  </view>

  <!-- å¸–å­åˆ—è¡¨ -->
  <scroll-view
    class="post-list"
    scroll-y
    bindscrolltolower="onLoadMore"
    refresher-enabled
    bindrefresherrefresh="onRefresh"
    refresher-triggered="{{isRefreshing}}"
  >
    <view class="post-item" wx:for="{{posts}}" wx:key="id" bindtap="onTapPost" data-id="{{item.id}}">
      <view class="post-header">
        <image class="author-avatar" src="{{item.author_avatar || '/images/default-avatar.png'}}" mode="aspectFill" />
        <view class="author-info">
          <text class="author-name">{{item.author_name}}</text>
          <text class="post-meta">{{item.time_label}} Â· {{item.college_name || item.school_name || ''}}</text>
        </view>
      </view>

      <text class="post-content">{{item.content}}</text>

      <!-- çº¦çƒå¡ç‰‡ï¼ˆå¦‚æœæœ‰å…³è”çš„çº¦çƒï¼‰ -->
      <view class="match-box" wx:if="{{item.invitation}}" catchtap="onTapInvitation" data-id="{{item.invitation.id}}">
        <view class="match-title">ğŸ“ å‘èµ·çº¦çƒ</view>
        <view class="match-detail">
          <text wx:if="{{item.invitation.location}}">ğŸ“ {{item.invitation.location}}</text>
          <text wx:if="{{item.invitation.scheduled_time}}"> Â· ğŸ• {{item.invitation.time_label}}</text>
        </view>
        <button class="match-join" catchtap="onJoinInvitation" data-id="{{item.invitation.id}}">æˆ‘è¦å‚åŠ </button>
      </view>

      <!-- å›¾ç‰‡ç½‘æ ¼ -->
      <view class="post-images {{item.images.length === 1 ? 'single' : (item.images.length <= 4 ? 'grid-2' : 'grid-3')}}" wx:if="{{item.images && item.images.length > 0}}">
        <image
          wx:for="{{item.images}}"
          wx:for-item="img"
          wx:key="*this"
          class="post-image"
          src="{{img}}"
          mode="aspectFill"
          catchtap="onPreviewImage"
          data-urls="{{item.images}}"
          data-current="{{img}}"
        />
      </view>

      <view class="post-actions">
        <view class="action-item {{item.is_liked ? 'liked' : ''}}" catchtap="onTapLike" data-id="{{item.id}}" data-index="{{index}}">
          <text class="icon-heart">{{item.is_liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
          <text class="action-count">{{item.like_count || 0}}</text>
        </view>
        <view class="action-item">
          <text class="icon-comment">ğŸ’¬</text>
          <text class="action-count">{{item.comment_count || 0}}</text>
        </view>
      </view>
    </view>

    <!-- çº¦çƒå¡ç‰‡åˆ—è¡¨ï¼ˆå¦‚æœæ²¡æœ‰å¸–å­å…³è”çš„çº¦çƒï¼Œå•ç‹¬æ˜¾ç¤ºï¼‰ -->
    <block wx:for="{{standaloneInvitations}}" wx:key="id">
      <view class="post-item invitation-card" bindtap="onTapInvitation" data-id="{{item.id}}">
        <view class="post-header">
          <image class="author-avatar" src="{{item.creator_avatar || '/images/default-avatar.png'}}" mode="aspectFill" />
          <view class="author-info">
            <text class="author-name">{{item.creator_name}}</text>
            <text class="post-meta">{{item.time_label}} Â· {{item.school_name || ''}}</text>
          </view>
        </view>

        <view class="match-box standalone">
          <view class="match-title">ğŸ“ {{item.title || 'çº¦çƒ'}}</view>
          <view class="match-detail">
            <text wx:if="{{item.location}}">ğŸ“ {{item.location}}</text>
            <text wx:if="{{item.scheduled_time}}"> Â· ğŸ• {{item.scheduled_time_label}}</text>
          </view>
          <view class="match-progress">
            <text class="progress-text">{{item.participant_count || 1}}/{{item.max_participants}}äººå‚ä¸</text>
          </view>
          <button class="match-join" wx:if="{{item.status === 'open'}}" catchtap="onJoinInvitation" data-id="{{item.id}}">æˆ‘è¦å‚åŠ </button>
          <view class="match-status" wx:else>{{item.status === 'full' ? 'å·²æ»¡å‘˜' : (item.status === 'ongoing' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ')}}</view>
        </view>
      </view>
    </block>

    <view class="load-more" wx:if="{{isLoading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
    <view class="no-more" wx:if="{{noMore && posts.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
    <view class="empty" wx:if="{{!isLoading && posts.length === 0 && standaloneInvitations.length === 0}}">
      <text class="empty-icon">ğŸ“</text>
      <text class="empty-text">è¿˜æ²¡æœ‰åŠ¨æ€ï¼Œå¿«æ¥å‘ç¬¬ä¸€æ¡å§</text>
    </view>
  </scroll-view>
</view>
